<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸ˆì—° ë„ìš°ë¯¸ - ê±´ê°•í•œ ë‚´ì¼ì„ ìœ„í•œ ì²«ê±¸ìŒ</title>
    <meta name="description" content="ê¸ˆì—°ì„ ë„ì™€ì£¼ëŠ” ìŠ¤ë§ˆíŠ¸í•œ ì•±ìœ¼ë¡œ ê±´ê°•í•œ ì‚¶ì„ ì‹œì‘í•˜ì„¸ìš”">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <style>
        /* ì—¬ê¸°ì— ì•ì—ì„œ ë°›ì€ CSS ì „ì²´ë¥¼ ë„£ìœ¼ì„¸ìš” */


:root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --primary-light: #818cf8;
    --secondary: #8b5cf6;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --bg: #ffffff;
    --bg-secondary: #f8fafc;
    --surface: #ffffff;
    --text: #1e293b;
    --text-secondary: #64748b;
    --border: #e2e8f0;
    --shadow: rgba(0, 0, 0, 0.1);
    --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    --gradient-glow: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
}

[data-theme="dark"] {
    --primary: #818cf8;
    --primary-dark: #6366f1;
    --primary-light: #a5b4fc;
    --secondary: #a78bfa;
    --success: #34d399;
    --warning: #fbbf24;
    --danger: #f87171;
    --bg: #0f172a;
    --bg-secondary: #1e293b;
    --surface: #1e293b;
    --text: #f1f5f9;
    --text-secondary: #94a3b8;
    --border: #334155;
    --shadow: rgba(0, 0, 0, 0.3);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
    background: var(--bg);
    color: var(--text);
    transition: all 0.3s ease;
    overflow-x: hidden;
    min-height: 100vh;
    width: 100vw;
}

.app-container {
    max-width: 480px;
    margin: 0 auto;
    min-height: 100vh;
    background: var(--bg);
    position: relative;
    padding-bottom: 80px;
    width: 100%;
}

.page {
    display: none;
    padding: 20px;
    padding-top: 80px;
    animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    scroll-behavior: smooth;
}

.page.active {
    display: block;
    animation: fadeInFromTop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeInFromTop {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

@keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

@keyframes slideTextLeft {
    from { opacity: 0; transform: translateX(30px); }
    to { opacity: 1; transform: translateX(0); }
}

@keyframes iosCardFlyIn {
    0% {
        opacity: 0;
        transform: scale(0.3) translateY(100vh) translateZ(-1000px);
    }
    60% {
        opacity: 1;
        transform: scale(1.05) translateY(-10px) translateZ(0);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0) translateZ(0);
    }
}

@keyframes headerExpandFromCenter {
    0% {
        opacity: 0;
        transform: translateX(-50%) translateY(0) scaleY(0);
        transform-origin: center top;
    }
    100% {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scaleY(1);
        transform-origin: center top;
    }
}

@keyframes navExpandFromCenter {
    0% {
        opacity: 0;
        transform: translateX(-50%) translateY(0) scaleY(0);
        transform-origin: center bottom;
    }
    100% {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scaleY(1);
        transform-origin: center bottom;
    }
}

@keyframes celebrateIcon {
    0%, 100% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.2) rotate(-10deg); }
    50% { transform: scale(1.1) rotate(10deg); }
    75% { transform: scale(1.2) rotate(-5deg); }
}

@keyframes pulse-danger {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.01); opacity: 0.95; }
    100% { transform: scale(1); opacity: 1; }
}
.status-indicator {
    position: absolute;
    top: 10px;
    left: 10px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--success);
    z-index: 10;
}

.status-dot {
    width: 6px;
    height: 6px;
    background: var(--success);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.header {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px;
    height: 70px;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(7px);
    -webkit-backdrop-filte: blur(7px);
    border-bottom: 1px solid rgba(226, 232, 240, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    box-shadow: 0 2px 15px var(--shadow);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.header.scrolled {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(226, 232, 240, 0.8);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

/* ë‹¤í¬ëª¨ë“œ */
[data-theme="dark"] .header {
    background: rgba(15, 23, 42, 0.7);
    border-bottom: 1px solid rgba(51, 65, 85, 0.3);
}

[data-theme="dark"] .header.scrolled {
    background: rgba(15, 23, 42, 0.95);
    border-bottom: 1px solid rgba(51, 65, 85, 0.8);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

/* ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ ì‹œ í—¤ë” ìˆ¨ê¹€ (ì„ íƒì‚¬í•­) */
.header.header-hide {
    transform: translateX(-50%) translateY(-100%);
}

.header.hidden {
    transform: translateX(-50%) translateY(-100%);
}

.header-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    transition: all 0.3s ease;
}



.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px;
    height: 80px;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(7px);
    -webkit-backdrop-filter: blur(7px);
    border-top: 1px solid rgba(226, 232, 240, 0.3);
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 100;
    padding: 0 10px;
    box-shadow: 0 -2px 15px var(--shadow);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ìŠ¤í¬ë¡¤ ì‹œ ë°”í…€ ë„¤ë¹„ê²Œì´ì…˜ë„ ì§„í•˜ê²Œ */
.header.scrolled ~ .bottom-nav {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(226, 232, 240, 0.8);
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
}

[data-theme="dark"] .bottom-nav {
    background: rgba(15, 23, 42, 0.7);
    border-top: 1px solid rgba(51, 65, 85, 0.3);
}

[data-theme="dark"] .header.scrolled ~ .bottom-nav {
    background: rgba(15, 23, 42, 0.95);
    border-top: 1px solid rgba(51, 65, 85, 0.8);
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
}

.bottom-nav.hidden {
    transform: translateX(-50%) translateY(100%);
}
.nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    padding: 10px 8px;
    border-radius: 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: var(--text-secondary);
    position: relative;
}

.nav-item:hover {
    transform: translateY(-2px);
}

.nav-item.active {
    color: var(--primary);
    background: var(--gradient-glow);
    transform: scale(1.05);
}

.nav-icon {
    font-size: 24px;
    transition: all 0.3s ease;
}

.nav-item.active .nav-icon {
    transform: scale(1.1);
}

.nav-label {
    font-size: clamp(9px, 2.5vw, 11px);
    font-weight: 600;
    transition: all 0.3s ease;
}

.welcome-screen {
    text-align: center;
    padding: 40px 20px;
    height: 100vh;
    width: 100vw;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: var(--gradient-glow);
    position: fixed;
    top: 0;
    left: 0;
    overflow: hidden;
    touch-action: none;
}

.welcome-icon {
    font-size: clamp(70px, 20vw, 100px);
    margin-bottom: 30px;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-10px) rotate(2deg); }
    50% { transform: translateY(-15px) rotate(0deg); }
    75% { transform: translateY(-10px) rotate(-2deg); }
}

.welcome-title {
    font-size: clamp(28px, 8vw, 36px);
    font-weight: 900;
    margin-bottom: 20px;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: slideIn 0.8s ease 0.3s both;
}

.welcome-subtitle {
    font-size: clamp(14px, 4vw, 18px);
    color: var(--text-secondary);
    line-height: 1.8;
    margin-bottom: 50px;
    animation: slideIn 0.8s ease 0.6s both;
}

.risk-display-page {
    text-align: center;
    padding: 40px 20px;
    height: 100vh;
    width: 100vw;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: var(--gradient-glow);
    position: fixed;
    top: 0;
    left: 0;
    overflow: auto;
    touch-action: pan-y;
    box-sizing: border-box;
    z-index: 100;
}

.risk-title {
    font-size: clamp(24px, 7vw, 32px);
    font-weight: 900;
    margin-bottom: 20px;
    color: var(--text);
    text-align: center;
}

.risk-stats {
    background: var(--surface);
    border-radius: 24px;
    padding: 30px;
    margin: 30px 0;
    box-shadow: 0 8px 30px var(--shadow);
    max-width: 400px;
    width: 100%;
}

.risk-stat-item {
    display: flex;
    justify-content: space-between;
    padding: 16px 0;
    border-bottom: 1px solid var(--border);
}

.risk-stat-item:last-child {
    border-bottom: none;
}

.risk-stat-label {
    font-size: clamp(14px, 3.5vw, 16px);
    color: var(--text-secondary);
}

.risk-stat-value {
    font-size: clamp(16px, 4vw, 20px);
    font-weight: 700;
    color: var(--primary);
}

.risk-level-badge {
    display: inline-block;
    padding: 12px 24px;
    border-radius: 30px;
    font-size: clamp(16px, 4vw, 20px);
    font-weight: 800;
    margin: 20px 0;
}

.risk-level-high {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
}

.risk-level-medium {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning);
}

.risk-level-low {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
}

.motivation-card {
    background: var(--gradient-glow);
    border: 1px solid var(--primary);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.motivation-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(99, 102, 241, 0.1), transparent);
    animation: shimmer 3s infinite;
}

.motivation-text {
    font-size: clamp(14px, 4vw, 18px);
    font-weight: 700;
    color: var(--primary);
    position: relative;
    z-index: 1;
    animation: slideTextLeft 0.5s ease-in-out;
}

.card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px var(--shadow);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px var(--shadow);
}

.card-title {
    font-size: clamp(14px, 3.5vw, 16px);
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--text);
}

.card-value {
    font-size: clamp(24px, 6vw, 32px);
    font-weight: 900;
    color: var(--primary);
    margin: 12px 0;
}

.card-label {
    font-size: clamp(12px, 3vw, 14px);
    color: var(--text-secondary);
}
.form-group {
    margin-bottom: 24px;
    animation: slideIn 0.6s ease;
}

label {
    display: block;
    margin-bottom: 10px;
    color: var(--text);
    font-weight: 600;
    font-size: 15px;
}

input, select {
    width: 100%;
    padding: 16px 18px;
    border: 2px solid var(--border);
    border-radius: 16px;
    font-size: 16px;
    background: var(--surface);
    color: var(--text);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    transform: translateY(-2px);
}

.checkbox-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    padding: 16px;
    background: var(--bg-secondary);
    border: 2px solid var(--border);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.checkbox-label:hover {
    border-color: var(--primary);
    background: var(--surface);
    transform: translateY(-2px);
}

.checkbox-label input:checked + span {
    color: var(--primary);
    font-weight: 700;
}

.checkbox-label input {
    width: auto;
    margin-right: 10px;
}

.btn {
    width: 100%;
    padding: 18px;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: 16px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
    position: relative;
    overflow: hidden;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(99, 102, 241, 0.4);
}

.btn:active {
    transform: translateY(-1px);
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.level-card {
    background: var(--gradient-primary);
    color: white;
    border-radius: 24px;
    padding: 36px;
    text-align: center;
    margin-bottom: 24px;
    box-shadow: 0 12px 40px rgba(99, 102, 241, 0.4);
    position: relative;
    overflow: hidden;
}

.level-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    animation: shimmer 4s infinite;
}

.level-badge {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.25);
    padding: 8px 16px;
    border-radius: 25px;
    font-size: 13px;
    font-weight: 700;
    backdrop-filter: blur(10px);
}

.level-number {
    font-size: clamp(56px, 15vw, 72px);
    font-weight: 900;
    margin: 15px 0;
    text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 1;
}

.level-title {
    font-size: clamp(18px, 5vw, 22px);
    font-weight: 700;
    margin-bottom: 20px;
    opacity: 0.95;
    position: relative;
    z-index: 1;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 20px;
    position: relative;
    z-index: 1;
}

.progress-fill {
    height: 100%;
    background: white;
    border-radius: 4px;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
}

.stats-grid {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: clamp(8px, 2vw, 16px);
    margin-bottom: 24px;
}

.stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: clamp(12px, 3vw, 20px);
    padding: clamp(12px, 3vw, 24px);
    text-align: center;
    box-shadow: 0 4px 20px var(--shadow);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 110px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.stat-card:hover {
    transform: translateY(-6px) scale(1.02);
    box-shadow: 0 12px 35px var(--shadow);
}

.stat-icon {
    font-size: clamp(24px, 6vw, 32px);
    margin-bottom: clamp(6px, 1.5vw, 12px);
}

.stat-value {
    font-size: clamp(20px, 5vw, 28px);
    font-weight: 900;
    color: var(--primary);
    margin: clamp(4px, 1.5vw, 12px) 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 0 4px;
}

.stat-label {
    font-size: clamp(10px, 2.5vw, 13px);
    color: var(--text-secondary);
    font-weight: 600;
}

.progress-summary {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
}

.progress-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
}

.progress-item:last-child {
    border-bottom: none;
}

.progress-label {
    font-size: clamp(12px, 3vw, 14px);
    color: var(--text-secondary);
}

.progress-value {
    font-size: clamp(14px, 3.5vw, 16px);
    font-weight: 700;
    color: var(--primary);
}

.level-preview {
    background: var(--gradient-glow);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 24px;
}

.level-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.current-level {
    font-size: clamp(14px, 4vw, 18px);
    font-weight: 700;
    color: var(--primary);
    white-space: nowrap;
}

.next-level {
    font-size: clamp(11px, 3vw, 14px);
    color: var(--text-secondary);
    white-space: nowrap;
}

.level-progress-mini {
    width: 100%;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
}

.level-progress-fill-mini {
    height: 100%;
    background: var(--gradient-primary);
    border-radius: 3px;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.time-display {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 28px;
    text-align: center;
    margin-bottom: 24px;
    box-shadow: 0 4px 20px var(--shadow);
    position: relative;
}

.time-value {
    font-size: clamp(24px, 6vw, 36px);
    font-weight: 900;
    color: var(--primary);
    margin: 12px 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 0 8px;
}

.daily-quote {
    background: var(--gradient-glow);
    border: 1px solid var(--primary);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.daily-quote::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(99, 102, 241, 0.1), transparent);
    animation: shimmer 3s infinite;
}

.quote-text {
    font-size: clamp(13px, 3.5vw, 16px);
    font-weight: 600;
    color: var(--primary);
    position: relative;
    z-index: 1;
    line-height: 1.6;
    margin-bottom: 12px;
}

.quote-author {
    font-size: clamp(12px, 3vw, 14px);
    color: var(--text-secondary);
    position: relative;
    z-index: 1;
}

.past-smoking-card {
    background: var(--gradient-glow);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.past-smoking-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px var(--shadow);
}

.past-smoking-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.past-smoking-icon {
    font-size: 24px;
}

.past-smoking-title {
    font-size: clamp(14px, 3.5vw, 16px);
    font-weight: 700;
    color: var(--text);
}

.past-smoking-info {
    font-size: clamp(12px, 3vw, 14px);
    color: var(--text-secondary);
    line-height: 1.5;
}

.past-smoking-section {
    background: var(--gradient-glow);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
}

.section-header {
    font-size: clamp(16px, 4.5vw, 20px);
    font-weight: 800;
    margin-bottom: 20px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 10px;
}

.danger-level {
    margin-top: 15px;
    padding: 10px 15px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 700;
    text-align: center;
    transition: all 0.3s ease;
    border: 1px solid var(--border);
    line-height: 1.4;
    color: var(--text-secondary);
}

.danger-low {
    background-color: rgba(16, 185, 129, 0.1);
    color: var(--success) !important;
    border-color: var(--success);
}

.danger-medium {
    background-color: rgba(245, 158, 11, 0.1);
    color: var(--warning) !important;
    border-color: var(--warning);
}

.danger-high {
    background-color: rgba(239, 68, 68, 0.15);
    color: var(--danger) !important;
    border-color: var(--danger);
    animation: pulse-danger 1.5s infinite;
}
.achievement-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 18px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.achievement-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px var(--shadow);
}

.achievement-item.completed {
    border-color: var(--success);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.1) 100%);
}

.achievement-item.locked {
    opacity: 0.6;
}

.achievement-icon {
    font-size: clamp(32px, 8vw, 40px);
    flex-shrink: 0;
}

.achievement-content {
    flex: 1;
}

.achievement-title {
    font-size: clamp(14px, 3.5vw, 16px);
    font-weight: 700;
    margin-bottom: 6px;
    color: var(--text);
}

.achievement-desc {
    font-size: clamp(12px, 3vw, 14px);
    color: var(--text-secondary);
    line-height: 1.5;
}

.achievement-progress {
    width: 100%;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 12px;
}

.achievement-progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    border-radius: 3px;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.savings-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.savings-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px var(--shadow);
}

.savings-item.unlocked {
    border-color: var(--success);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.1) 100%);
}

.savings-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 12px;
}

.savings-emoji {
    font-size: clamp(28px, 7vw, 36px);
}

.savings-info {
    flex: 1;
}

.savings-name {
    font-size: clamp(14px, 3.5vw, 16px);
    font-weight: 700;
    color: var(--text);
}

.savings-price {
    font-size: clamp(12px, 3vw, 14px);
    color: var(--text-secondary);
}

.savings-progress-bar {
    width: 100%;
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
}

.savings-progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    border-radius: 4px;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.savings-percent {
    text-align: right;
    font-size: clamp(11px, 3vw, 13px);
    font-weight: 700;
    color: var(--primary);
    margin-top: 8px;
}

.achievement-notification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 1999;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.achievement-notification-overlay.show {
    opacity: 1;
    pointer-events: auto;
}

.achievement-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    max-width: 90%;
    width: 400px;
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(226, 232, 240, 0.3);
    border-radius: 28px;
    padding: 40px 30px;
    text-align: center;
    z-index: 2000;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

[data-theme="dark"] .achievement-notification {
    background: rgba(15, 23, 42, 0.75);
    border: 1px solid rgba(51, 65, 85, 0.3);
}
.achievement-notification.show {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
}

.achievement-notification-icon {
    font-size: 80px;
    margin-bottom: 20px;
    animation: celebrateIcon 0.8s ease;
}

.achievement-notification-title {
    font-size: 24px;
    font-weight: 900;
    color: var(--primary);
    margin-bottom: 12px;
}

.achievement-notification-desc {
    font-size: 16px;
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 24px;
}

.achievement-notification-btn {
    width: 100%;
    padding: 16px;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: 14px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.achievement-notification-btn:active {
    transform: scale(0.95);
}

.settings-section {
    margin-bottom: 36px;
}

.settings-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-secondary);
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.settings-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.settings-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--shadow);
}

.settings-item:active {
    transform: scale(0.98);
}

.settings-info {
    flex: 1;
}

.settings-label {
    font-size: clamp(14px, 3.5vw, 16px);
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
}

.settings-value {
    font-size: clamp(12px, 3vw, 14px);
    color: var(--text-secondary);
}

.toggle-switch {
    width: 56px;
    height: 32px;
    background: var(--border);
    border-radius: 16px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.toggle-switch.active {
    background: var(--primary);
}

.toggle-knob {
    width: 28px;
    height: 28px;
    background: white;
    border-radius: 14px;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.toggle-switch.active .toggle-knob {
    transform: translateX(24px);
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

.modal.active {
    display: flex;
}

.modal-content {
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(226, 232, 240, 0.3);
    border-radius: 24px;
    padding: clamp(20px, 5vw, 36px);
    max-width: min(400px, 90vw);
    max-height: 85vh;
    overflow-y: auto;
    width: 100%;
    text-align: center;
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

[data-theme="dark"] .modal-content {
    background: rgba(15, 23, 42, 0.75);
    border: 1px solid rgba(51, 65, 85, 0.3);
}
@keyframes slideUp {
    from { opacity: 0; transform: translateY(40px) scale(0.9); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-title {
    font-size: clamp(16px, 4.5vw, 22px);
    font-weight: 700;
    margin-bottom: clamp(12px, 3vw, 16px);
    color: var(--text);
    line-height: 1.3;
}

.modal-text {
    font-size: clamp(12px, 3.2vw, 15px);
    color: var(--text-secondary);
    margin-bottom: clamp(16px, 4vw, 28px);
    line-height: 1.5;
    max-height: 55vh;
    overflow-y: auto;
}
.modal-buttons {
    display: flex;
    gap: 12px;
}

/* ê¸°ì¡´ .modal-btn ì°¾ì•„ì„œ ìˆ˜ì • */
.modal-btn {
    flex: 1;
    
    padding: clamp(12px, 3vw, 16px);
    border: none;
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    border-radius: 12px;
    font-size: clamp(13px, 3.5vw, 15px);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 44px;
}

.modal-btn:hover {
    transform: translateY(-2px);
}

.modal-btn-cancel {
    background: var(--bg-secondary);
    color: var(--text);
}

.modal-btn-confirm {
    background: var(--gradient-primary);
    color: white;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
}

/* Modal í…ìŠ¤íŠ¸ ì˜ì—­ ìµœëŒ€ ë†’ì´ ì„¤ì • */
.modal-text {
    max-height: 60vh;
    overflow-y: auto;
}

/* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
.modal-text::-webkit-scrollbar {
    width: 6px;
}

.modal-text::-webkit-scrollbar-track {
    background: var(--bg-secondary);
    border-radius: 3px;
}

.modal-text::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 3px;
}


/* SOS Button */
.sos-button-container {
    margin-bottom: 24px;
}

.sos-button {
    width: 100%;
    padding: 24px;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: none;
    border-radius: 20px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    position: relative;
    overflow: hidden;
}

.sos-button::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: shimmer 3s infinite;
}

.sos-button:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 12px 35px rgba(239, 68, 68, 0.5);
}

.sos-button:active {
    transform: scale(0.98);
}

.sos-icon {
    font-size: 28px;
    animation: pulse 2s infinite;
}

.sos-text {
    position: relative;
    z-index: 1;
}

/* ê¸°ì¡´ .sos-modal-content ì°¾ì•„ì„œ ìˆ˜ì • */
.sos-modal-content {
    max-width: min(420px, 90vw);
    max-height: 85vh;
    overflow-y: auto;
    padding: clamp(20px, 5vw, 40px);
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(226, 232, 240, 0.3);
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}


[data-theme="dark"] .sos-modal-content {
    background: rgba(15, 23, 42, 0.75);
    border: 1px solid rgba(51, 65, 85, 0.3);
}

/* ê¸°ì¡´ .sos-modal-header ì°¾ì•„ì„œ ìˆ˜ì • */
.sos-modal-header {
    text-align: center;
    margin-bottom: clamp(16px, 4vw, 24px);
}

/* ê¸°ì¡´ .sos-modal-icon ì°¾ì•„ì„œ ìˆ˜ì • */
.sos-modal-icon {
    font-size: clamp(40px, 12vw, 64px);
    margin-bottom: clamp(12px, 3vw, 16px);
    animation: celebrateIcon 1s ease infinite;
}

/* ê¸°ì¡´ .sos-modal-title ì°¾ì•„ì„œ ìˆ˜ì • */
.sos-modal-title {
    font-size: clamp(18px, 5vw, 24px);
    font-weight: 900;
    color: var(--primary);
    line-height: 1.3;
}

/* ê¸°ì¡´ .sos-modal-body ì°¾ì•„ì„œ ìˆ˜ì • */
.sos-modal-body {
    background: rgba(248, 250, 252, 0.4);
    backdrop-filter: blur(15x);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid rgba(226, 232, 240, 0.3);
    border-radius: 16px;
    padding: clamp(16px, 4vw, 24px);
    margin-bottom: clamp(12px, 3vw, 20px);
    min-height: clamp(80px, 20vw, 120px);
    max-height: 40vh;
    overflow-y: auto;
    line-height: 1.6;
    font-size: clamp(13px, 3.5vw, 15px);
    color: var(--text);
}

[data-theme="dark"] .sos-modal-body {
    background: rgba(30, 41, 59, 0.4);
    border: 1px solid rgba(51, 65, 85, 0.3);
}

/* ê¸°ì¡´ .sos-modal-actions ì°¾ì•„ì„œ ìˆ˜ì • */
.sos-modal-actions {
    display: grid;
    grid-template-columns: 1fr;
    gap: clamp(8px, 2vw, 12px);
    margin-bottom: clamp(8px, 2vw, 12px);
}

/* ê¸°ì¡´ .sos-action-btn ì°¾ì•„ì„œ ìˆ˜ì • */
.sos-action-btn {
    padding: clamp(12px, 3vw, 16px);
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 2px solid rgba(226, 232, 240, 0.5);
    border-radius: 12px;
    font-size: clamp(13px, 3.5vw, 15px);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

[data-theme="dark"] .sos-action-btn {
    background: rgba(30, 41, 59, 0.5);
    border: 2px solid rgba(51, 65, 85, 0.5);
}

.sos-action-btn:hover {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.15);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    transform: translateY(-2px);
}

.sos-action-btn:active {
    transform: scale(0.98);
}

/* Breathing Guide */
/* ê¸°ì¡´ .breathing-modal-content ì°¾ì•„ì„œ ìˆ˜ì • */
.breathing-modal-content {
    max-width: min(400px, 90vw);
    max-height: 85vh;
    padding: clamp(20px, 5vw, 40px) clamp(15px, 4vw, 30px);
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(226, 232, 240, 0.3);
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

[data-theme="dark"] .breathing-modal-content {
    background: rgba(15, 23, 42, 0.75);
    border: 1px solid rgba(51, 65, 85, 0.3);
}

.breathing-circle {
    width: clamp(130px, 40vw, 200px);
    height: clamp(130px, 40vw, 200px);
    margin: 0 auto clamp(20px, 5vw, 30px);
    border-radius: 50%;
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 4s ease-in-out, box-shadow 4s ease-in-out;
    box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
    will-change: transform;
}

/* ë“¤ì´ì‰¬ê¸° ì• ë‹ˆë©”ì´ì…˜ */
.breathing-circle.inhale {
    transform: scale(1.3);
    box-shadow: 0 12px 50px rgba(99, 102, 241, 0.5);
}

/* ë‚´ì‰¬ê¸° ì• ë‹ˆë©”ì´ì…˜ */
.breathing-circle.exhale {
    transform: scale(0.85);
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
}

.breathing-text {
    font-size: clamp(18px, 5vw, 24px);
    font-weight: 700;
    color: white;
    transition: opacity 0.5s ease;
}

.breathing-instruction {
    text-align: center;
    font-size: clamp(14px, 3.5vw, 18px);
    font-weight: 600;
    color: var(--text);
    margin-bottom: clamp(12px, 3vw, 20px);
    line-height: 1.5;
    padding: 0 10px;
    transition: opacity 0.5s ease;
    min-height: clamp(40px, 10vw, 60px);
}

/* ì‘ì€ í™”ë©´ ìµœì í™” */
@media (max-width: 380px) {
    .breathing-circle {
        width: clamp(100px, 35vw, 150px);
        height: clamp(100px, 35vw, 150px);
    }
    
    .breathing-circle.inhale {
        transform: scale(1.25);
    }
    
    .breathing-circle.exhale {
        transform: scale(0.9);
    }
}

/* ë§¤ìš° ì‘ì€ í™”ë©´ (í”Œë¦½í° ë“±) */
@media (max-width: 320px), (max-height: 500px) {
    .breathing-circle {
        width: 70px;
        height: 70px;
        margin: 0 auto 10px;
    }
    
    .breathing-circle.inhale {
        transform: scale(1.2);
    }
    
    .breathing-circle.exhale {
        transform: scale(0.9);
    }
    
    .breathing-text {
        font-size: 16px;
    }
    
    .breathing-instruction {
        font-size: 12px;
        margin-bottom: 8px;
        min-height: 30px;
    }
}

@keyframes breathePulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}



@keyframes slideInFromTop {
    0% {
        /* translateX(-50%)ëŠ” ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ í•„ìˆ˜ê°’ */
        transform: translate(-50%, -100%); 
        opacity: 0;
    }
    100% {
        transform: translate(-50%, 0); 
        opacity: 1;
    }
}

/* ë„¤ë¹„ê²Œì´ì…˜: ì•„ë˜ì—ì„œ ìœ„ë¡œ ìŠ¬ë¼ì´ë“œ */
@keyframes slideInFromBottom {
    0% {
        /* translateX(-50%)ëŠ” ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ í•„ìˆ˜ê°’ */
        transform: translate(-50%, 100%); 
        opacity: 0;
    }
    100% {
        transform: translate(-50%, 0); 
        opacity: 1;
    }
}
.first-launch .header {
    animation: slideInFromTop 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.3s both;
}
.first-launch .bottom-nav {
    animation: slideInFromBottom 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.3s both;
}
/* ê¸°ì¡´ ì½”ë“œë¥¼ ì°¾ì•„ì„œ ì´ë ‡ê²Œ ìˆ˜ì • */
.first-launch .time-display {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 0.5s both;
}
.first-launch .sos-button-container {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 0.65s both;
}
.first-launch .motivation-card {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 0.8s both;
}
.first-launch .stat-card:nth-child(1) {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 0.95s both;
}
.first-launch .stat-card:nth-child(2) {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 1.05s both;
}
.first-launch .stat-card:nth-child(3) {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 1.15s both;
}
.first-launch .stat-card:nth-child(4) {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 1.25s both;
}
/* ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ ì½”ë“œë“¤ ì•„ë˜ì— ì¶”ê°€ */
.first-launch .sos-button-container {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 1.35s both;
}
.first-launch .level-preview {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 1.45s both;
}
.first-launch .progress-summary {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 1.55s both;
}
.first-launch .daily-quote {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 1.65s both;
}
.first-launch .past-smoking-card {
    animation: iosCardFlyIn 0.9s cubic-bezier(0.4, 1.2, 0.5, 1) 1.75s both;
}



@media (max-width: 380px) {
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    .level-number {
        font-size: 60px;
    }
    .nav-label {
        font-size: 10px;
    }
    .checkbox-grid {
        grid-template-columns: 1fr;
    }
}

/* ê°€ë¡œ ëª¨ë“œ ë° ì‘ì€ í™”ë©´ ëŒ€ì‘ */
@media (max-height: 600px) {
    .sos-modal-content,
    .breathing-modal-content {
        max-height: 95vh;
        padding: 15px;
    }
    
    .sos-modal-body {
        max-height: 30vh;
        min-height: 60px;
    }
    
    .breathing-circle {
        width: 120px;
        height: 120px;
        margin-bottom: 15px;
    }
    
    .sos-modal-actions {
        gap: 8px;
    }
    
    #personalMessageInput {
        min-height: 80px;
        max-height: 25vh;
    }
}

/* ë§¤ìš° ì‘ì€ í™”ë©´ */
@media (max-width: 320px) {
    .sos-modal-content,
    .breathing-modal-content {
        padding: 15px 12px;
    }
    
    .sos-action-btn {
        font-size: 12px;
        padding: 10px;
    }
}

/* ê°€ë¡œ ëª¨ë“œ ë° ì‘ì€ í™”ë©´ ëŒ€ì‘ */
@media (max-height: 600px) {
    .modal-content {
        max-height: 95vh;
        padding: clamp(15px, 3vw, 25px);
    }
    
    .modal-text {
        max-height: 50vh;
        font-size: clamp(11px, 2.8vw, 14px);
        margin-bottom: clamp(12px, 3vw, 20px);
    }
    
    .modal-buttons {
        gap: 8px;
    }
    
    .modal-btn {
        padding: clamp(10px, 2.5vw, 14px);
        font-size: clamp(12px, 3vw, 14px);
    }
}

/* ë§¤ìš° ì‘ì€ í™”ë©´ (í”Œë¦½í° ë“±) */
@media (max-width: 320px), (max-height: 500px) {
    .modal-content {
        padding: 15px;
        max-height: 92vh;
    }
    
    .modal-title {
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .modal-text {
        font-size: 11px;
        line-height: 1.4;
        margin-bottom: 12px;
        max-height: 45vh;
    }
    
    .modal-btn {
        padding: 10px;
        font-size: 12px;
        min-height: 40px;
    }
}
   </style>
</head>
<body>
    <div class="app-container" id="app">
        <!-- Header -->
        <div class="header" id="header">
            <div class="header-title" id="headerTitle">ê¸ˆì—° ë„ìš°ë¯¸</div>
        </div>

        <!-- Welcome Page -->
        <div class="page active" id="welcomePage">
            <div class="welcome-screen">
                <div class="welcome-icon">ğŸŒŸ</div>
                <div class="welcome-title">ìƒˆë¡œìš´ ì‹œì‘</div>
                <div class="welcome-subtitle">
                    ë‹¹ì‹ ì˜ ê±´ê°•í•œ ë‚´ì¼ì„ ìœ„í•œ<br>
                    ì²« ê±¸ìŒì„ ì‹œì‘í•©ë‹ˆë‹¤<br>
                    í•¨ê»˜ í•´ë³´ì‹œê² ì–´ìš”?
                </div>
                <button class="btn" onclick="goToOnboarding()">ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>

        <!-- Onboarding Page -->
        <div class="page" id="onboardingPage">
            <h2 style="font-size: 28px; font-weight: 900; margin-bottom: 30px; color: var(--primary);">ì •ë³´ ì…ë ¥</h2>
            
            <div class="form-group">
                <label>ì´ë¦„</label>
                <input type="text" id="userName" placeholder="í™ê¸¸ë™">
            </div>
            <div class="form-group">
                <label>ìƒë…„ì›”ì¼</label>
                <input type="date" id="birthDate">
            </div>
            <div class="past-smoking-section"> 
                <div class="section-header">ğŸš¬ ê³¼ê±° í¡ì—° ì •ë³´</div> 
                <div class="form-group"> 
                    <label>í¡ì—° ê¸°ê°„ (ë…„)</label> 
                    <input type="number" id="smokingYears" placeholder="7"> 
                </div> 
                <div class="form-group"> 
                    <label>í•˜ë£¨ í¡ì—°ëŸ‰ (ê°‘)</label> 
                    <input type="number" step="0.1" id="packsPerDay" placeholder="1" oninput="calculateMonthlySpending()"> 
                </div> 
                <div class="form-group"> 
                    <label>í•œ ê°‘ë‹¹ ë‹´ë°° ê°œë¹„ ìˆ˜</label> 
                    <input type="number" id="cigarettesPerPack" value="20"> 
                </div> 
                <div class="form-group"> 
                    <label>í•œ ê°‘ ê°€ê²© (ì›)</label> 
                    <input type="number" id="pricePerPack" placeholder="4500" oninput="calculateMonthlySpending()"> 
                </div> 
                <div class="form-group"> 
                    <label>ì›” í‰ê·  ë‹´ë°°ë¹„ (ì›)</label> 
                    <input type="text" id="monthlySpending" placeholder="ìë™ ê³„ì‚°" readonly> 
                </div> 
                <div id="dangerLevel" class="danger-level"></div>
            </div>
            <div class="form-group">
                <label>ë‹´ë°°ê°€ ìƒê°ë‚˜ëŠ” ìƒí™©</label>
                <div class="checkbox-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" value="ìŠ¤íŠ¸ë ˆìŠ¤">
                        <span>ìŠ¤íŠ¸ë ˆìŠ¤</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="ì‹ì‚¬í›„">
                        <span>ì‹ì‚¬ í›„</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="ìˆ ìë¦¬">
                        <span>ìˆ ìë¦¬</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="ì•„ì¹¨">
                        <span>ì•„ì¹¨ ê¸°ìƒ</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="íœ´ì‹">
                        <span>íœ´ì‹ ì‹œê°„</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="ì§€ë£¨í•¨">
                        <span>ì§€ë£¨í•  ë•Œ</span>
                    </label>
                </div>
            </div>
            <button class="btn" onclick="showRiskDisplay()">ë‹¤ìŒ</button>
        </div>

        <!-- Risk Display Page -->
        <div class="page" id="riskDisplayPage">
            <div class="risk-display-page">
                <div class="risk-icon">âš ï¸</div>
                <div class="risk-title">ê³¼ê±° í¡ì—°ì˜ ì˜í–¥</div>
                
                <div class="risk-stats">
                    <div class="risk-stat-item">
                        <span class="risk-stat-label">í¡ì—° ê¸°ê°„</span>
                        <span class="risk-stat-value" id="riskYears">-</span>
                    </div>
                    <div class="risk-stat-item">
                        <span class="risk-stat-label">í•˜ë£¨ í¡ì—°ëŸ‰</span>
                        <span class="risk-stat-value" id="riskPacks">-</span>
                    </div>
                    <div class="risk-stat-item">
                        <span class="risk-stat-label">ì´ í¡ì—° ê°œë¹„</span>
                        <span class="risk-stat-value" id="riskTotalCigs">-</span>
                    </div>
                    <div class="risk-stat-item">
                        <span class="risk-stat-label">ì´ ì†Œë¹„ ê¸ˆì•¡</span>
                        <span class="risk-stat-value" id="riskTotalMoney">-</span>
                    </div>
                </div>

                <div class="risk-level-badge" id="riskLevelBadge">-</div>

                <div style="font-size: clamp(14px, 3.5vw, 16px); color: var(--text-secondary); line-height: 1.8; margin: 20px 0;">
                    í•˜ì§€ë§Œ ì§€ê¸ˆë¶€í„° ê¸ˆì—°ì„ ì‹œì‘í•˜ë©´<br>
                    ê±´ê°•ì„ ë˜ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!
                </div>

                <button class="btn" onclick="goToDateTimeInput()">ê¸ˆì—° ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>

        <!-- DateTime Input Page -->
        <div class="page" id="dateTimeInputPage">
            <div class="welcome-screen">
                <div class="welcome-icon">ğŸ¯</div>
                <div class="welcome-title">ê¸ˆì—° ì‹œì‘ ì‹œê°„</div>
                <div class="welcome-subtitle">
                    ë§ˆì§€ë§‰ ë‹´ë°°ë¥¼ í”¼ìš´ ì‹œê°„ ë˜ëŠ”<br>
                    ê¸ˆì—°ì„ ì‹œì‘í•  ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”
                </div>
                
                <div class="form-group" style="margin: 40px 0;">
                    <input type="datetime-local" id="quitDateTime" style="font-size: 16px; text-align: center;">
                </div>

                <button class="btn" onclick="startQuitJourney()">ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>
        <!-- Level Page -->
        <div class="page page-container" id="levelPage">
            <div class="level-card">
                <div class="level-badge">ê¸ˆì—°ì¤‘</div>
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">í˜„ì¬ ë ˆë²¨</div>
                <div class="level-number" id="levelNumber">1</div>
                <div class="level-title" id="levelName">ê¸ˆì—° ìƒˆì‹¹</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="levelProgressBar"></div>
                </div>
                <div style="font-size: 13px; opacity: 0.85; margin-top: 10px;" id="levelProgressText">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ 0%</div>
            </div>
            <div class="section-header">ğŸ† ë‹¬ì„±í•œ ì—…ì </div>
            <div id="completedAchievements"></div>
            <div class="section-header" style="margin-top: 30px;">ğŸ¯ ë‹¤ìŒ ëª©í‘œ</div>
            <div id="nextAchievement"></div>
        </div>

        <!-- Savings Page -->
        <div class="page page-container" id="savingsPage">
            <div class="card" style="text-align: center; margin-bottom: 24px;">
                <div class="card-label">ì§€ê¸ˆê¹Œì§€ ì ˆì•½í•œ ê¸ˆì•¡</div>
                <div class="card-value" id="totalSavings">0ì›</div>
            </div>
            <div class="section-header">ğŸ’° ì ˆì•½í•œ ëˆìœ¼ë¡œ ì‚´ ìˆ˜ ìˆëŠ” ê²ƒ</div>
            <div id="savingsItems"></div>
        </div>

        <!-- Home Page -->
        <div class="page page-container" id="homePage">
            <div class="time-display">
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    ê¸ˆì—° ì¤‘
                </div>
                <div class="stat-label">ê¸ˆì—°í•œ ì‹œê°„</div>
                <div class="time-value" id="quitTime">0ì¼ 0ì‹œê°„</div>
            </div>

            <div class="motivation-card">
                <div class="motivation-text" id="motivationText">ë‹¹ì‹ ì€ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ’°</div>
                    <div class="stat-value" id="savedMoney">0ì›</div>
                    <div class="stat-label">ì•„ë‚€ ëˆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â¤ï¸</div>
                    <div class="stat-value" id="healthImprovement">0%</div>
                    <div class="stat-label">ê±´ê°• ê°œì„ ë„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸš­</div>
                    <div class="stat-value" id="cigarettesAvoided">0ê°œë¹„</div>
                    <div class="stat-label">ì•ˆ í”¼ìš´ ë‹´ë°°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â±ï¸</div>
                    <div class="stat-value" id="lifeGained">0ë¶„</div>
                    <div class="stat-label">ëŠ˜ì–´ë‚œ ìˆ˜ëª…</div>
                </div>
            </div>

            <!-- Home Page ë‚´ë¶€, time-display ë‹¤ìŒì— ì¶”ê°€ -->
            <div class="sos-button-container">
                <button class="sos-button" onclick="showSOSModal()">
                    <div class="sos-icon">ğŸ†˜</div>
                    <div class="sos-text">ìœ„ê¸° ìƒí™© ë„ì›€</div>
                </button>
            </div>
            
                        <!-- SOS Modal -->
            <div class="modal" id="sosModal">
                <div class="modal-content sos-modal-content">
                    <div class="sos-modal-header">
                        <div class="sos-modal-icon">ğŸ’ª</div>
                        <div class="sos-modal-title">ë‹¹ì‹ ì€ ê°•í•©ë‹ˆë‹¤!</div>
                    </div>

                    <div class="sos-modal-body" id="sosModalBody">
                        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ë‚´ìš© -->
                    </div>

                    <div class="sos-modal-actions">
                        <button class="sos-action-btn" onclick="showBreathingGuide()">
                            ğŸ« ì‹¬í˜¸í¡ ê°€ì´ë“œ
                        </button>
                        <button class="sos-action-btn" onclick="showMotivationalQuote()">
                            ğŸ’¬ ê°•ë ¥í•œ ëª…ì–¸
                        </button>
                        <button class="sos-action-btn" onclick="showPersonalMessage()">
                            ğŸ’Œ ë‚˜ì—ê²Œ ì“´ í¸ì§€
                        </button>
                    </div>

                    <button class="modal-btn modal-btn-confirm" onclick="closeSOSModal()" style="margin-top: 20px;">
                        ìœ„ê¸°ë¥¼ ê·¹ë³µí–ˆìŠµë‹ˆë‹¤! ğŸ‰
                    </button>
                </div>
            </div>

            <!-- Breathing Guide Modal -->
            <div class="modal" id="breathingModal">
                <div class="modal-content breathing-modal-content">
                    <div class="breathing-circle" id="breathingCircle">
                        <div class="breathing-text" id="breathingText">ì¤€ë¹„...</div>
                    </div>
                    <div class="breathing-instruction" id="breathingInstruction">
                        ì‹¬í˜¸í¡ì„ ì‹œì‘í•©ë‹ˆë‹¤
                    </div>
                    <button class="modal-btn modal-btn-cancel" onclick="stopBreathing()" style="margin-top: 20px;">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>

            <!-- Personal Message Setup Modal -->
            <div class="modal" id="personalMessageModal">
                <div class="modal-content">
                    <div class="modal-title">ë‚˜ì—ê²Œ ì“°ëŠ” í¸ì§€</div>
                    <div class="modal-text">
                        ë‹´ë°°ë¥¼ í”¼ìš°ê³  ì‹¶ì„ ë•Œ ì½ì„<br>ë‚˜ ìì‹ ì—ê²Œ ì“°ëŠ” ê²©ë ¤ì˜ ë©”ì‹œì§€
                    </div>
                    <textarea id="personalMessageInput" 
                              placeholder="ì˜ˆ: ë‚˜ëŠ” í•  ìˆ˜ ìˆì–´! ì´ ìˆœê°„ë§Œ ì°¸ìœ¼ë©´ ë¼. ê°€ì¡±ì„ ìƒê°í•´, ê±´ê°•ì„ ìƒê°í•´!"
                              style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid var(--border); border-radius: 12px; font-size: 14px; resize: vertical; font-family: inherit; margin: 16px 0;"></textarea>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-btn-cancel" onclick="closePersonalMessageModal()">ì·¨ì†Œ</button>
                        <button class="modal-btn modal-btn-confirm" onclick="savePersonalMessage()">ì €ì¥</button>
                    </div>
                </div>
            </div>


            <div class="level-preview">
                <div class="section-header" style="margin-bottom: 16px;">ğŸ† ë ˆë²¨ ì •ë³´</div>
                <div class="level-info">
                    <span class="current-level" id="currentLevelHome">ê¸ˆì—° ìƒˆì‹¹ Lv.1</span>
                    <span class="next-level" id="nextLevelHome">ë‹¤ìŒ: ê¸ˆì—° ìƒˆë‚´ê¸°</span>
                </div>
                <div class="level-progress-mini">
                    <div class="level-progress-fill-mini" id="levelProgressMini"></div>
                </div>
                <div style="text-align: right; font-size: 12px; color: var(--text-secondary); margin-top: 8px;" id="levelTimeRemaining">ë‚¨ì€ ì‹œê°„: ê³„ì‚° ì¤‘...</div>
            </div>

            <div class="progress-summary">
                <div class="section-header" style="margin-bottom: 16px;">ğŸ“Š í˜„ì¬ ì§„í–‰ì‚¬í•­</div>
                <div class="progress-item">
                    <span class="progress-label">ë‹¬ì„±í•œ ì—…ì </span>
                    <span class="progress-value" id="completedCount">0ê°œ</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">ì ˆì•½ ê°€ëŠ¥í•œ í•­ëª©</span>
                    <span class="progress-value" id="unlockedSavings">0ê°œ</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">ê±´ê°• íšŒë³µë„</span>
                    <span class="progress-value" id="healthProgress">0%</span>
                </div>
            </div>

            <div class="daily-quote">
                <div class="quote-text" id="dailyQuoteText">"ì„±ê³µì€ ì‘ì€ ë…¸ë ¥ë“¤ì˜ í•©ì´ë©°, ë§¤ì¼ ë°˜ë³µë˜ëŠ” ê²ƒì…ë‹ˆë‹¤."</div>
                <div class="quote-author" id="dailyQuoteAuthor">- ë¡œë²„íŠ¸ ì½œë¦¬ì–´</div>
            </div>

            <div class="past-smoking-card" onclick="showPastSmokingInfo()">
                <div class="past-smoking-header">
                    <div class="past-smoking-icon">ğŸ“Š</div>
                    <div>
                        <div class="past-smoking-title">ê³¼ê±° í¡ì—° ì •ë³´</div>
                        <div class="past-smoking-info" id="pastSmokingInfoHome">í¡ì—° ê¸°ê°„ ë° ìœ„í—˜ë„ í™•ì¸</div>
                    </div>
                    <div style="font-size: 20px; color: var(--text-secondary);">â€º</div>
                </div>
            </div>
        </div>

        <!-- Progress Page -->
        <div class="page page-container" id="progressPage">
            <div class="section-header">ğŸ“Š ê±´ê°• íšŒë³µ ê³¼ì •</div>
            <div id="allAchievements"></div>
        </div>
        <!-- Settings Page -->
        <div class="page page-container" id="settingsPage">
            <div class="settings-section">
                <div class="settings-title">í”„ë¡œí•„</div>
                <div class="settings-item">
                    <div class="settings-info">
                        <div class="settings-label" id="profileName">í™ê¸¸ë™</div>
                        <div class="settings-value" id="quitStartDate">ê¸ˆì—° ì‹œì‘ì¼</div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">ê¸ˆì—° ê´€ë¦¬</div>
                <div class="settings-item" onclick="resetQuit()">
                    <div class="settings-info">
                        <div class="settings-label">ê¸ˆì—° ë‹¤ì‹œ ì‹œì‘</div>
                        <div class="settings-value">ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</div>
                    </div>
                    <div style="font-size: 20px;">ğŸ”„</div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">í…Œë§ˆ</div>
                <div class="settings-item" onclick="toggleTheme()">
                    <div class="settings-info">
                        <div class="settings-label">ë‹¤í¬ëª¨ë“œ</div>
                        <div class="settings-value">í…Œë§ˆ ë³€ê²½</div>
                    </div>
                    <div class="toggle-switch" id="themeToggle">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">ì•Œë¦¼ ì„¤ì •</div>
                <div class="settings-item" onclick="toggleDailyReminders()">
                    <div class="settings-info">
                        <div class="settings-label">ì¼ì¼ ê²©ë ¤ ì•Œë¦¼</div>
                        <div class="settings-value">í•˜ë£¨ 3ë²ˆ ê²©ë ¤ ë©”ì‹œì§€</div>
                    </div>
                    <div class="toggle-switch" id="reminderToggle">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
                <div class="settings-item" onclick="testNotification()">
                    <div class="settings-info">
                        <div class="settings-label">ì•Œë¦¼ í…ŒìŠ¤íŠ¸</div>
                        <div class="settings-value">ì•Œë¦¼ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸</div>
                    </div>
                    <div style="font-size: 20px;">ğŸ””</div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">ì•± ì •ë³´</div>
                <div class="settings-item" onclick="shareApp()">
                    <div class="settings-info">
                        <div class="settings-label">ì•± ê³µìœ í•˜ê¸°</div>
                        <div class="settings-value">ì¹œêµ¬ì—ê²Œ ì¶”ì²œí•˜ê¸°</div>
                    </div>
                    <div style="font-size: 20px;">ğŸ“¤</div>
                </div>
                <div class="settings-item" onclick="sendEmail()">
                    <div class="settings-info">
                        <div class="settings-label">ê°œë°œìì—ê²Œ ë©”ì¼ ë³´ë‚´ê¸°</div>
                        <div class="settings-value">í”¼ë“œë°± ë° ë¬¸ì˜</div>
                    </div>
                    <div style="font-size: 20px;">ğŸ“§</div>
                </div>
                <div class="settings-item" style="cursor: default;">
                    <div class="settings-info">
                        <div class="settings-label">ë²„ì „</div>
                        <div class="settings-value">ê°œë°œì ë²„ì „ 2.2.0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav" id="bottomNav">
            <div class="nav-item active" onclick="navigateTo('level')">
                <div class="nav-icon">ğŸ†</div>
                <div class="nav-label">ë ˆë²¨</div>
            </div>
            <div class="nav-item" onclick="navigateTo('savings')">
                <div class="nav-icon">ğŸ’°</div>
                <div class="nav-label">ì ˆì•½</div>
            </div>
            <div class="nav-item" onclick="navigateTo('home')">
                <div class="nav-icon">ğŸ </div>
                <div class="nav-label">í™ˆ</div>
            </div>
            <div class="nav-item" onclick="navigateTo('progress')">
                <div class="nav-icon">ğŸ“Š</div>
                <div class="nav-label">ì§„í–‰</div>
            </div>
            <div class="nav-item" onclick="navigateTo('settings')">
                <div class="nav-icon">âš™ï¸</div>
                <div class="nav-label">ì„¤ì •</div>
            </div>
        </div>

<!-- Reset Modal - ê¸°ì¡´ ì½”ë“œ êµì²´ -->
<div class="modal" id="resetModal">
    <div class="modal-content">
        <div class="modal-title">ê¸ˆì—° ë‹¤ì‹œ ì‹œì‘</div>
        <div class="modal-text" id="resetModalText">
            ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.<br>
            ì •ë§ ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeResetModal()">ì·¨ì†Œ</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmReset()">í™•ì¸</button>
        </div>
    </div>
</div>

        <!-- Past Smoking Info Modal -->
        <div class="modal" id="pastSmokingModal">
            <div class="modal-content">
                <div class="modal-title">ê³¼ê±° í¡ì—° ì •ë³´</div>
                <div class="modal-text" id="pastSmokingDetails"></div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-confirm" onclick="closePastSmokingModal()">í™•ì¸</button>
                </div>
            </div>
        </div>

        <!-- Achievement Notification (ì•Œë¦¼ íŒì—…) -->
        <div class="achievement-notification-overlay" id="achievementOverlay" onclick="closeAchievementNotification()"></div>
        <div class="achievement-notification" id="achievementNotification">
            <div class="achievement-notification-icon" id="achievementIcon">ğŸ‰</div>
            <div class="achievement-notification-title" id="achievementTitle">ì¶•í•˜í•©ë‹ˆë‹¤!</div>
            <div class="achievement-notification-desc" id="achievementDesc">ìƒˆë¡œìš´ ì—…ì ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤</div>
            <button class="achievement-notification-btn" onclick="closeAchievementNotification()">í™•ì¸</button>
        </div>
    </div>

    <script>
        /* ì—¬ê¸°ì— JavaScript ì½”ë“œê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤ */
        let userData = {};
let updateInterval, motivationInterval;
let currentMotivationIndex = 0;
let touchStartX = 0, touchEndX = 0;
let currentPageIndex = 0;
const pageOrder = ['level', 'savings', 'home', 'progress', 'settings'];
let db = null;
let isFirstLaunch = false;
let achievedMilestones = new Set();
let unlockedSavingsGoals = new Set();
let lastLevel = 0;

const motivationMessages = [
    "ì €ëŠ” ë‹´ë°°ë¥¼ ì•ˆ íƒœì› ìŠµë‹ˆë‹¤!", "ì €ëŠ” ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!", "ë‚˜ëŠ” ë¬´ì—‡ì´ë“  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!",
    "ë‚˜ëŠ” ê°•í•œ ì‚¬ëŒì…ë‹ˆë‹¤!", "ë‚˜ëŠ” ììœ ë¡œì›Œì¡ŒìŠµë‹ˆë‹¤!", "ë‚˜ëŠ” ê±´ê°•ì„ ë˜ì°¾ê³  ìˆìŠµë‹ˆë‹¤!",
    "ë‚˜ëŠ” ë‚´ ì‚¶ì˜ ì£¼ì¸ì…ë‹ˆë‹¤!", "ë‚˜ëŠ” í•´ëƒˆìŠµë‹ˆë‹¤!", "ë‚˜ëŠ” í¬ê¸°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!",
    "ë‚˜ëŠ” ë” ë‚˜ì€ ì‚¬ëŒì´ ë˜ê³  ìˆìŠµë‹ˆë‹¤!"
];

const dailyQuotes = [
    { text: "ì„±ê³µì€ ì‘ì€ ë…¸ë ¥ë“¤ì˜ í•©ì´ë©°, ë§¤ì¼ ë°˜ë³µë˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë‹¹ì‹ ì´ ê¸ˆì—°ì„ ì„ íƒí•œ ë§¤ ìˆœê°„ì´ ë°”ë¡œ ê·¸ ì‘ì€ ìŠ¹ë¦¬ì…ë‹ˆë‹¤.", author: "ë¡œë²„íŠ¸ ì½œë¦¬ì–´" },
    { text: "ë³€í™”ëŠ” ê³ í†µìŠ¤ëŸ½ì§€ë§Œ, ë³€í•˜ì§€ ì•ŠëŠ” ê²ƒì€ ë”ìš± ê³ í†µìŠ¤ëŸ½ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì€ ì§€ê¸ˆ ê°€ì¥ ìš©ê¸°ìˆëŠ” ë³€í™”ë¥¼ ë§Œë“¤ì–´ê°€ê³  ìˆìŠµë‹ˆë‹¤.", author: "ë²„ë‚˜ë“œ ì‡¼" },
    { text: "ìŠµê´€ì´ ë°”ë€Œë©´ ìš´ëª…ì´ ë°”ë€ë‹ˆë‹¤. ê¸ˆì—°ì´ë¼ëŠ” ìƒˆë¡œìš´ ìŠµê´€ìœ¼ë¡œ ë‹¹ì‹ ì˜ ì¸ìƒì´ ì™„ì „íˆ ë‹¬ë¼ì§ˆ ê²ƒì…ë‹ˆë‹¤.", author: "ìœŒë¦¬ì—„ ì œì„ìŠ¤" },
    { text: "ê°€ì¥ ì–´ë‘ìš´ ë°¤ì´ ì§€ë‚˜ë©´ ê°€ì¥ ë°ì€ ìƒˆë²½ì´ ì˜µë‹ˆë‹¤. ê¸ˆë‹¨ ì¦ìƒë„ ì§€ë‚˜ê°€ë©´ ë” ê±´ê°•í•˜ê³  ììœ ë¡œìš´ ë‹¹ì‹ ì´ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.", author: "í† ë§ˆìŠ¤ í’€ëŸ¬" },
    { text: "ë‹¹ì‹ ì´ í•  ìˆ˜ ìˆë‹¤ê³  ë¯¿ë“ , í•  ìˆ˜ ì—†ë‹¤ê³  ë¯¿ë“ , ë‹¹ì‹ ì´ ì˜³ìŠµë‹ˆë‹¤. ê¸ˆì—°ì— ëŒ€í•œ ë¯¿ìŒì´ ì„±ê³µì˜ ì—´ì‡ ì…ë‹ˆë‹¤.", author: "í—¨ë¦¬ í¬ë“œ" }
];

const milestones = [
    { minutes: 1, level: 1, title: "1ë¶„ ë‹¬ì„±", desc: "ì‹¬ë°•ìˆ˜ì™€ í˜ˆì••ì´ ì •ìƒí™”ë˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤.", icon: "ğŸ’—" },
    { minutes: 20, level: 2, title: "20ë¶„ ì„±ê³µ", desc: "ì†ê³¼ ë°œì˜ í˜ˆì•¡ìˆœí™˜ì´ ê°œì„ ë©ë‹ˆë‹¤.", icon: "ğŸ–ï¸" },
    { minutes: 480, level: 3, title: "8ì‹œê°„ ëŒíŒŒ", desc: "í˜ˆì¤‘ ì¼ì‚°í™”íƒ„ì†Œê°€ ì •ìƒìœ¼ë¡œ íšŒë³µë©ë‹ˆë‹¤.", icon: "ğŸ«" },
    { minutes: 1440, level: 4, title: "í•˜ë£¨ ì™„ì„±", desc: "ì‹¬ì¥ë§ˆë¹„ ìœ„í—˜ì´ ê°ì†Œí•˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤.", icon: "â¤ï¸" },
    { minutes: 4320, level: 5, title: "3ì¼ í†µê³¼", desc: "ë‹ˆì½”í‹´ì´ ì™„ì „íˆ ë°°ì¶œë©ë‹ˆë‹¤.", icon: "ğŸ¯" },
    { minutes: 7200, level: 6, title: "5ì¼ ëŒíŒŒ", desc: "í›„ê°ê³¼ ë¯¸ê°ì´ í¬ê²Œ í–¥ìƒë©ë‹ˆë‹¤.", icon: "ğŸ‘ƒ" },
    { minutes: 10080, level: 7, title: "1ì£¼ ì™„ë£Œ", desc: "ê¸ˆë‹¨ ì¦ìƒì´ ì™„í™”ë˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤.", icon: "âš¡" },
    { minutes: 20160, level: 8, title: "2ì£¼ ë‹¬ì„±", desc: "í˜ˆì•¡ìˆœí™˜ê³¼ í ê¸°ëŠ¥ì´ í–¥ìƒë©ë‹ˆë‹¤.", icon: "ğŸ‹ï¸" },
    { minutes: 30240, level: 9, title: "3ì£¼ í†µê³¼", desc: "ì§‘ì¤‘ë ¥ê³¼ ìˆ˜ë©´ì˜ ì§ˆì´ ê°œì„ ë©ë‹ˆë‹¤.", icon: "ğŸ§ " },
    { minutes: 43200, level: 10, title: "1ê°œì›” ì™„ì„±", desc: "ê¸°ì¹¨, ìˆ¨ê°€ì¨ ì¦ìƒì´ ê°ì†Œë©ë‹ˆë‹¤.", icon: "ğŸŒ¬ï¸" },
    { minutes: 60480, level: 11, title: "6ì£¼ ëŒíŒŒ", desc: "íì˜ ìì²´ ì •í™” ê¸°ëŠ¥ì´ íšŒë³µë©ë‹ˆë‹¤.", icon: "ğŸ§¹" },
    { minutes: 86400, level: 12, title: "2ê°œì›” ë‹¬ì„±", desc: "ì „ë°˜ì ì¸ ì²´ë ¥ì´ ì¦ê°€ë©ë‹ˆë‹¤.", icon: "ğŸ’ª" },
    { minutes: 129600, level: 13, title: "3ê°œì›” ì™„ë£Œ", desc: "í ê¸°ëŠ¥ê³¼ ë©´ì—­ë ¥ì´ í–¥ìƒë©ë‹ˆë‹¤.", icon: "ğŸ›¡ï¸" },
    { minutes: 172800, level: 14, title: "4ê°œì›” í†µê³¼", desc: "í˜¸í¡ê¸° ì¦ìƒì´ ì§€ì†ì ìœ¼ë¡œ ê°ì†Œë©ë‹ˆë‹¤.", icon: "ğŸŒ³" },
    { minutes: 216000, level: 15, title: "5ê°œì›” ë‹¬ì„±", desc: "í ì„¬ëª¨ ê¸°ëŠ¥ì´ ì™„ì „íˆ íšŒë³µë©ë‹ˆë‹¤.", icon: "ğŸŒ²" },
    { minutes: 259200, level: 16, title: "6ê°œì›” ì™„ì„±", desc: "ë§Œì„± ê¸°ì¹¨, ê°€ë˜ê°€ í¬ê²Œ ê°ì†Œë©ë‹ˆë‹¤.", icon: "ğŸ†" },
    { minutes: 388800, level: 17, title: "9ê°œì›” ëŒíŒŒ", desc: "í ê¸°ëŠ¥ì´ ìµœëŒ€ 10% ì¦ê°€ë©ë‹ˆë‹¤.", icon: "ğŸ¥‡" },
    { minutes: 525600, level: 18, title: "1ë…„ ë‹¬ì„±", desc: "ì‹¬ì¥ë³‘ ìœ„í—˜ì´ 50% ê°ì†Œë©ë‹ˆë‹¤.", icon: "ğŸ’" },
    { minutes: 1051200, level: 19, title: "2ë…„ ì™„ë£Œ", desc: "ì‹¬ì¥ë§ˆë¹„ ìœ„í—˜ì´ ê·¹ì ìœ¼ë¡œ ê°ì†Œë©ë‹ˆë‹¤.", icon: "ğŸ’–" },
    { minutes: 1576800, level: 20, title: "3ë…„ í†µê³¼", desc: "êµ¬ê°•ì•” ìœ„í—˜ì´ 50% ê°ì†Œë©ë‹ˆë‹¤.", icon: "ğŸ‘„" },
    { minutes: 2102400, level: 21, title: "4ë…„ ë‹¬ì„±", desc: "ë‡Œì¡¸ì¤‘ ìœ„í—˜ì´ ì§€ì†ì ìœ¼ë¡œ ê°ì†Œë©ë‹ˆë‹¤.", icon: "ğŸ§ " },
    { minutes: 2628000, level: 22, title: "5ë…„ ì™„ì„±", desc: "ë‡Œì¡¸ì¤‘ ìœ„í—˜ì´ ë¹„í¡ì—°ì ìˆ˜ì¤€ì´ ë©ë‹ˆë‹¤.", icon: "ğŸ§ " },
    { minutes: 3679200, level: 23, title: "7ë…„ ëŒíŒŒ", desc: "ì£¼ìš” ì•” ë°œìƒ ìœ„í—˜ì´ ì§€ì†ì ìœ¼ë¡œ ê°ì†Œë©ë‹ˆë‹¤.", icon: "ğŸ—ï¸" },
    { minutes: 5256000, level: 24, title: "10ë…„ ë‹¬ì„±", desc: "íì•” ì‚¬ë§ ìœ„í—˜ì´ 50% ê°ì†Œë©ë‹ˆë‹¤.", icon: "ğŸŒŸ" }
];

const savingsGoals = [
    { name: "ë¯¹ìŠ¤ì»¤í”¼ 10ê°œì…", price: 3500, emoji: "â˜•" },
    { name: "í¸ì˜ì  ìŒë£Œ ë° ê°„ì‹", price: 4500, emoji: "ğŸ¥¤" },
    { name: "ë¡œë˜ ë³µê¶Œ 1ì¥", price: 5000, emoji: "ğŸ€" },
    { name: "í–„ë²„ê±° ì„¸íŠ¸", price: 9000, emoji: "ğŸ”" },
    { name: "ì¼ë°˜ ì ì‹¬ ì‹ì‚¬", price: 12000, emoji: "ğŸš" },
    { name: "ì˜í™” í‹°ì¼“ í•œ ì¥", price: 16000, emoji: "ğŸ¬" },
    { name: "ë² ìŠ¤íŠ¸ì…€ëŸ¬ ì±… 1ê¶Œ", price: 20000, emoji: "ğŸ“š" },
    { name: "ë°°ë‹¬ ì¹˜í‚¨ í•œ ë§ˆë¦¬", price: 27000, emoji: "ğŸ—" },
    { name: "í•œ ë‹¬ OTT êµ¬ë…ë£Œ", price: 35000, emoji: "ğŸ“º" },
    { name: "ë³´ê¸‰í˜• ìš´ë™í™”", price: 59000, emoji: "ğŸ‘Ÿ" },
    { name: "í•œ ë‹¬ ëŒ€ì¤‘êµí†µë¹„", price: 75000, emoji: "ğŸšŒ" },
    { name: "ê¸°ë³¸ ë¬´ì„  ì´ì–´í°", price: 100000, emoji: "ğŸ§" },
    { name: "1ë°• 2ì¼ êµ­ë‚´ ì—¬í–‰ ê²½ë¹„", price: 250000, emoji: "ğŸ•ï¸" },
    { name: "ë³´ê¸‰í˜• íƒœë¸”ë¦¿", price: 480000, emoji: "ğŸ“±" },
    { name: "ë‹¨ê¸° í•´ì™¸ì—¬í–‰ í•­ê³µê¶Œ", price: 850000, emoji: "âœˆï¸" }
];

const levelNames = {
    1: "ê¸ˆì—° ìƒˆì‹¹", 2: "ê¸ˆì—° ìƒˆë‚´ê¸°", 3: "ê¸ˆì—° ë„ì „ì", 4: "ê¸ˆì—° ì‹¤ì²œê°€", 5: "ê¸ˆì—° ë‹¬ì¸",
    6: "ê¸ˆì—° ê³ ìˆ˜", 7: "ê¸ˆì—° ë§ˆìŠ¤í„°", 8: "ê¸ˆì—° ì±”í”¼ì–¸", 9: "ê¸ˆì—° ë ˆì „ë“œ", 10: "ê¸ˆì—° ì˜ì›…",
    11: "ê¸ˆì—° ì „ì„¤", 12: "ê¸ˆì—° ì‹ í™”", 13: "ê¸ˆì—° ë¶ˆë©¸ì", 14: "ê¸ˆì—° ê¶ê·¹ì"
};

function hideAllMainUI() {
    document.getElementById('header').classList.add('hidden');
    document.getElementById('bottomNav').classList.add('hidden');
    document.getElementById('welcomePage').classList.remove('active');
    document.getElementById('onboardingPage')?.classList.remove('active');
    document.getElementById('riskDisplayPage').classList.remove('active');
    document.getElementById('dateTimeInputPage').classList.remove('active');
    document.getElementById('main-app')?.classList.remove('active');
    document.body.classList.remove('first-launch', 'main-app-enter');
}

function initDatabase() {
    return new Promise((resolve, reject) => {
        if (!window.cordova || !window.sqlitePlugin) {
            console.log('SQLite not available, using localStorage');
            resolve(false);
            return;
        }

        db = window.sqlitePlugin.openDatabase({
            name: 'quitSmoking.db',
            location: 'default',
            androidDatabaseProvider: 'system'
        }, () => {
            db.executeSql(
                'CREATE TABLE IF NOT EXISTS userData (id INTEGER PRIMARY KEY, data TEXT)',
                [],
                () => {
                    console.log('Database initialized');
                    resolve(true);
                },
                (error) => {
                    console.error('Table creation error:', error);
                    reject(error);
                }
            );
        }, (error) => {
            console.error('Database open error:', error);
            reject(error);
        });
    });
}

async function init() {
    try {
        await initDatabase();
    } catch (e) {
        console.log('Database init failed, using localStorage only');
    }
    
    await loadDataSecure();
    checkIfLoggedIn();
    loadTheme();
    loadNotificationSettings(); // ì´ ì¤„ ì¶”ê°€
    setDailyQuote();
    calculateMonthlySpending();
    setupAutoSave();
    initPushNotifications();
    window.scrollTo(0, 0);
}

function checkIfLoggedIn() {
    hideAllMainUI();
    if (userData.quitDateTime) {
        showMainApp();
    } else {
        document.getElementById('welcomePage').classList.add('active');
    }
}

if (window.cordova) {
    document.addEventListener('deviceready', init, false);
} else {
    document.addEventListener('DOMContentLoaded', init);
}


function saveDataSecure() {
    userData.achievedMilestones = Array.from(achievedMilestones);
    userData.unlockedSavingsGoals = Array.from(unlockedSavingsGoals);
    userData.lastLevel = lastLevel;
    
    const dataString = JSON.stringify(userData);
    try {
        localStorage.setItem('quitSmokingData', dataString);
        localStorage.setItem('quitSmokingData_backup', dataString);
        localStorage.setItem('quitSmokingData_timestamp', Date.now().toString());
        sessionStorage.setItem('quitSmokingData', dataString);
    } catch (e) {
        console.error('localStorage save failed:', e);
    }

    if (db) {
        db.executeSql(
            'INSERT OR REPLACE INTO userData (id, data) VALUES (1, ?)',
            [dataString],
            () => console.log('Data saved to SQLite'),
            (error) => console.error('SQLite save error:', error)
        );
    }
}

function loadDataSecure() {
    return new Promise((resolve) => {
        if (db) {
            db.executeSql(
                'SELECT data FROM userData WHERE id = 1',
                [],
                (rs) => {
                    if (rs.rows.length > 0) {
                        try {
                            userData = JSON.parse(rs.rows.item(0).data);
                            if (userData.quitDateTime) {
                                userData.quitDateTime = new Date(userData.quitDateTime);
                            }
                            achievedMilestones = new Set(userData.achievedMilestones || []);
                            unlockedSavingsGoals = new Set(userData.unlockedSavingsGoals || []);
                            lastLevel = userData.lastLevel || 0;
                            console.log('Data loaded from SQLite');
                            resolve(true);
                            return;
                        } catch (e) {
                            console.error('SQLite parse error:', e);
                        }
                    }
                    loadFromLocalStorage();
                    resolve(false);
                },
                (error) => {
                    console.error('SQLite load error:', error);
                    loadFromLocalStorage();
                    resolve(false);
                }
            );
        } else {
            loadFromLocalStorage();
            resolve(false);
        }
    });

    function loadFromLocalStorage() {
        const sources = [
            'quitSmokingData',
            'quitSmokingData_backup',
            () => sessionStorage.getItem('quitSmokingData'),
            () => sessionStorage.getItem('quitSmokingData_emergency')
        ];
        for (let source of sources) {
            try {
                const saved = typeof source === 'function' ? source() : localStorage.getItem(source);
                if (saved) {
                    userData = JSON.parse(saved);
                    if (userData.quitDateTime) {
                        userData.quitDateTime = new Date(userData.quitDateTime);
                    }
                    achievedMilestones = new Set(userData.achievedMilestones || []);
                    unlockedSavingsGoals = new Set(userData.unlockedSavingsGoals || []);
                    lastLevel = userData.lastLevel || 0;
                    console.log('Data loaded from localStorage');
                    return true;
                }
            } catch (e) {
                continue;
            }
        }
        return false;
    }
}

function setupAutoSave() {
    setInterval(() => {
        if (userData.quitDateTime) saveDataSecure();
    }, 5000);
    ['beforeunload', 'pagehide', 'visibilitychange'].forEach(event => {
        window.addEventListener(event, () => {
            if (userData.quitDateTime) saveDataSecure();
        });
    });
    document.addEventListener('pause', saveDataSecure);
    document.addEventListener('resume', () => {
        loadDataSecure().then(() => {
            if (userData.quitDateTime) updateStats();
        });
    });
}

function goToOnboarding() {
    navigateToPage('onboardingPage');
    document.getElementById('header').classList.remove('hidden');
    document.getElementById('bottomNav').classList.add('hidden');
    setTimeout(() => window.scrollTo(0, 0), 100);
}

function calculateMonthlySpending() {
    const packsPerDayEl = document.getElementById('packsPerDay');
    const smokingYearsEl = document.getElementById('smokingYears');
    const pricePerPackEl = document.getElementById('pricePerPack');
    const monthlySpendingEl = document.getElementById('monthlySpending');

    if (!packsPerDayEl || !smokingYearsEl || !pricePerPackEl || !monthlySpendingEl) return;

    const packsPerDay = parseFloat(packsPerDayEl.value) || 0;
    const smokingYears = parseFloat(smokingYearsEl.value) || 0;
    const pricePerPack = parseFloat(pricePerPackEl.value) || 0;

    const monthlySpending = Math.floor(packsPerDay * pricePerPack * 30);
    monthlySpendingEl.value = monthlySpending.toLocaleString();

    const weeklySpending = Math.floor(packsPerDay * pricePerPack * 7);
    const weeklySpendingInput = document.getElementById('weeklySpending');
    if (weeklySpendingInput) {
        weeklySpendingInput.value = weeklySpending.toLocaleString();
    }
    
    updateDangerLevel(packsPerDay, smokingYears);
}

function updateDangerLevel(packsPerDay, smokingYears) {
    const dangerLevelEl = document.getElementById('dangerLevel');
    if (!dangerLevelEl) return;
    
    const riskScore = packsPerDay * smokingYears;
    let levelText, className;

    if (isNaN(riskScore) || riskScore <= 0 || packsPerDay <= 0 || smokingYears <= 0) {
        dangerLevelEl.textContent = 'ğŸš¬ í¡ì—° ì •ë³´ ì…ë ¥ ì‹œ ëˆ„ì  ìœ„í—˜ë„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        dangerLevelEl.className = 'danger-level';
        return;
    }

    if (riskScore < 5) {
        levelText = `[${riskScore.toFixed(1)} ê°‘ë…„] ğŸŒ± ë‚®ì€ ìœ„í—˜ (5ê°‘ë…„ ë¯¸ë§Œ)`;
        className = 'danger-low';
    } else if (riskScore < 20) {
        levelText = `[${riskScore.toFixed(1)} ê°‘ë…„] ğŸ’¡ ì¤‘ê°„ ìœ„í—˜ (ì „ë¬¸ ìƒë‹´ì´ ê¶Œì¥ë©ë‹ˆë‹¤)`;
        className = 'danger-medium';
    } else {
        levelText = `[${riskScore.toFixed(1)} ê°‘ë…„] ğŸš¨ ê³ ìœ„í—˜ (êµ­ê°€ íì•” ê²€ì§„ ê¶Œê³  ê¸°ì¤€)`;
        className = 'danger-high';
    }
    
    dangerLevelEl.textContent = `ëˆ„ì  í¡ì—° ìœ„í—˜ë„: ${levelText}`;
    dangerLevelEl.className = `danger-level ${className}`;
}

function showRiskDisplay() {
    const fields = ['userName', 'birthDate', 'smokingYears', 'packsPerDay', 'cigarettesPerPack', 'pricePerPack'];
    const values = {};
    
    for (let field of fields) {
        const value = document.getElementById(field).value;
        if (!value) {
            alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }
        values[field] = field.includes('smoking') || field.includes('packs') || field.includes('cigarettes') || field.includes('price') 
            ? parseFloat(value) 
            : value;
    }

    const situations = Array.from(document.querySelectorAll('#onboardingPage input[type="checkbox"]:checked'))
        .map(cb => cb.value);
    
    const totalCigarettesPerDay = values.packsPerDay * values.cigarettesPerPack;
    const riskScore = (values.smokingYears * totalCigarettesPerDay * values.pricePerPack) / 10000;
    
    userData = {
        ...values,
        monthlySpending: Math.floor(values.packsPerDay * values.pricePerPack * 30),
        riskScore: riskScore,
        situations
    };

    const totalCigs = Math.floor(values.smokingYears * 365 * values.packsPerDay * values.cigarettesPerPack);
    const totalMoney = Math.floor(values.smokingYears * 365 * values.packsPerDay * values.pricePerPack);
    
    document.getElementById('riskYears').textContent = values.smokingYears + 'ë…„';
    document.getElementById('riskPacks').textContent = values.packsPerDay + 'ê°‘/ì¼';
    document.getElementById('riskTotalCigs').textContent = totalCigs.toLocaleString() + 'ê°œë¹„';
    document.getElementById('riskTotalMoney').textContent = totalMoney.toLocaleString() + 'ì›';

    const riskBadge = document.getElementById('riskLevelBadge');
    
    if (userData.riskScore < 50) {
        riskBadge.textContent = 'ë‚®ì€ ìœ„í—˜ë„';
        riskBadge.className = 'risk-level-badge risk-level-low';
    } else if (userData.riskScore < 150) {
        riskBadge.textContent = 'ì¤‘ê°„ ìœ„í—˜ë„';
        riskBadge.className = 'risk-level-badge risk-level-medium';
    } else {
        riskBadge.textContent = 'ë†’ì€ ìœ„í—˜ë„';
        riskBadge.className = 'risk-level-badge risk-level-high';
    }

    navigateToPage('riskDisplayPage');
    document.getElementById('header').classList.add('hidden');
    document.getElementById('bottomNav').classList.add('hidden');
    setTimeout(() => window.scrollTo(0, 0), 100);
}

function goToDateTimeInput() {
    const now = new Date();
    const pad = (num) => (num < 10 ? '0' : '') + num;
    const datetimeString = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
    
    document.getElementById('quitDateTime').value = datetimeString;
    
    navigateToPage('dateTimeInputPage');
    document.getElementById('header').classList.add('hidden');
    document.getElementById('bottomNav').classList.add('hidden');
    setTimeout(() => window.scrollTo(0, 0), 100);
}

function startQuitJourney() {
    let quitDateTimeValue = document.getElementById('quitDateTime').value;

    if (!quitDateTimeValue) {
        const now = new Date();
        quitDateTimeValue = now.toISOString();
    }
    
    userData.quitDateTime = new Date(quitDateTimeValue);
    isFirstLaunch = true;
    saveDataSecure();
    
    // ì•Œë¦¼ ì„¤ì •
    if (window.cordova && window.cordova.plugins && window.cordova.plugins.notification) {
        setupNotifications();
    }
    
    showMainApp();
}
function showMainApp() {
    document.getElementById('riskDisplayPage').classList.remove('active');
    document.getElementById('dateTimeInputPage').classList.remove('active');
    document.getElementById('welcomePage').classList.remove('active');
    document.getElementById('onboardingPage')?.classList.remove('active');
    
    document.body.classList.remove('first-launch', 'main-app-enter');
    document.body.classList.add('first-launch');
    
    setupSwipeGestures();
    setupScrollHeader();
    
    document.getElementById('main-app')?.classList.add('active');
    document.getElementById('header').classList.remove('hidden');
    document.getElementById('bottomNav').classList.remove('hidden');
    
    navigateTo('home');
    startUpdates();
    setDailyQuote();
    startMotivationCycle();
    setupSwipeGestures();
    updateStats();
    setTimeout(() => window.scrollTo(0, 0), 100);
    
    setTimeout(() => {
        document.body.classList.remove('first-launch', 'main-app-enter');
        isFirstLaunch = false;
    }, 2500);
}
function navigateTo(page) {
    // ìœ íš¨í•œ í˜ì´ì§€ì¸ì§€ í™•ì¸
    if (!pageOrder.includes(page)) {
        console.error('Invalid page:', page);
        return;
    }
    
    const pages = {
        'level': 'levelPage',
        'savings': 'savingsPage',
        'home': 'homePage',
        'progress': 'progressPage',
        'settings': 'settingsPage'
    };
    const titles = {
        'level': 'ë ˆë²¨',
        'savings': 'ì ˆì•½',
        'home': 'ê¸ˆì—° ë„ìš°ë¯¸',
        'progress': 'ì§„í–‰ ìƒí™©',
        'settings': 'ì„¤ì •'
    };

    const oldPageIndex = currentPageIndex;
    currentPageIndex = pageOrder.indexOf(page);
    
    // ì˜ëª»ëœ ì¸ë±ìŠ¤ ë°©ì§€
    if (currentPageIndex === -1) {
        currentPageIndex = oldPageIndex;
        return;
    }
    
    const isSlideLeft = currentPageIndex > oldPageIndex;
    
    navigateToPage(pages[page], isSlideLeft);
    document.getElementById('headerTitle').textContent = titles[page];
    
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const navItems = document.querySelectorAll('.nav-item');
    if (navItems[currentPageIndex]) {
        navItems[currentPageIndex].classList.add('active');
    }
    
    setTimeout(() => window.scrollTo(0, 0), 50);
}

function navigateToPage(pageId, isSlideLeft = false) {
    const currentPage = document.querySelector('.page.active');
    const newPage = document.getElementById(pageId);
    
    if (currentPage) currentPage.classList.remove('active');
    newPage.classList.add('active');
}

function startUpdates() {
    updateStats();
    if (updateInterval) clearInterval(updateInterval);
    updateInterval = setInterval(updateStats, 1000);
}

function startMotivationCycle() {
    if (motivationInterval) clearInterval(motivationInterval);
    motivationInterval = setInterval(() => {
        currentMotivationIndex = (currentMotivationIndex + 1) % motivationMessages.length;
        const motivationEl = document.getElementById('motivationText');
        if (motivationEl) {
            motivationEl.style.animation = 'none';
            setTimeout(() => {
                motivationEl.textContent = motivationMessages[currentMotivationIndex];
                motivationEl.style.animation = 'slideTextLeft 0.5s ease-in-out';
            }, 50);
        }
    }, 5000);
}

function setupSwipeGestures() {
    const appContainer = document.getElementById('app');
    
    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•œ ì°¸ì¡° ì €ì¥
    if (appContainer._swipeHandlers) {
        appContainer.removeEventListener('touchstart', appContainer._swipeHandlers.start);
        appContainer.removeEventListener('touchmove', appContainer._swipeHandlers.move);
        appContainer.removeEventListener('touchend', appContainer._swipeHandlers.end);
    }
    
    let startX = 0;
    let startY = 0;
    let moveX = 0;
    let moveY = 0;
    let isSwiping = false;
    
    const handleTouchStart = (e) => {
        // ëª¨ë‹¬ì´ë‚˜ SOS ë²„íŠ¼ ë“± íŠ¹ì • ìš”ì†Œì—ì„œëŠ” ìŠ¤ì™€ì´í”„ ë¹„í™œì„±í™”
        if (e.target.closest('.modal, .sos-button, .sos-modal-content, .breathing-modal-content, textarea, input')) {
            return;
        }
        
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        isSwiping = false;
    };
    
    const handleTouchMove = (e) => {
        if (!startX || !startY) return;
        
        moveX = e.touches[0].clientX;
        moveY = e.touches[0].clientY;
        
        const diffX = Math.abs(moveX - startX);
        const diffY = Math.abs(moveY - startY);
        
        // ê°€ë¡œ ìŠ¤ì™€ì´í”„ê°€ ì„¸ë¡œ ìŠ¤ì™€ì´í”„ë³´ë‹¤ í´ ë•Œë§Œ í™œì„±í™”
        if (diffX > diffY && diffX > 30) {
            isSwiping = true;
        }
    };
    
    const handleTouchEnd = (e) => {
        if (!isSwiping || !startX) {
            startX = 0;
            startY = 0;
            isSwiping = false;
            return;
        }
        
        const endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        
        // ìµœì†Œ ìŠ¤ì™€ì´í”„ ê±°ë¦¬ 100px
        if (Math.abs(diff) > 100) {
            if (diff > 0) {
                // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ -> ë‹¤ìŒ í˜ì´ì§€
                navigateToNextPage();
            } else {
                // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ -> ì´ì „ í˜ì´ì§€
                navigateToPrevPage();
            }
        }
        
        // ì´ˆê¸°í™”
        startX = 0;
        startY = 0;
        isSwiping = false;
    };
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    appContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
    appContainer.addEventListener('touchmove', handleTouchMove, { passive: true });
    appContainer.addEventListener('touchend', handleTouchEnd, { passive: true });
    
    // ì°¸ì¡° ì €ì¥ (ë‚˜ì¤‘ì— ì œê±°í•  ìˆ˜ ìˆë„ë¡)
    appContainer._swipeHandlers = {
        start: handleTouchStart,
        move: handleTouchMove,
        end: handleTouchEnd
    };
}

function setupScrollHeader() {
    const header = document.getElementById('header');
    let lastScrollTop = 0;
    
    // ëª¨ë“  í˜ì´ì§€ì— ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll('.page').forEach(page => {
        page.addEventListener('scroll', function() {
            const scrollTop = this.scrollTop;
            
            if (scrollTop > 20) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
            
            // ìŠ¤í¬ë¡¤ ë°©í–¥ ê°ì§€ (ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ ì‹œ í—¤ë” ìˆ¨ê¸°ê¸° ì˜µì…˜)
            if (scrollTop > lastScrollTop && scrollTop > 100) {
                header.classList.add('header-hide');
            } else {
                header.classList.remove('header-hide');
            }
            
            lastScrollTop = scrollTop;
        });
    });
}

// SOS ê¸°ëŠ¥ ê´€ë ¨ ë³€ìˆ˜
let breathingInterval = null;
let breathingCycle = 0;

// ê°•ë ¥í•œ ëª…ì–¸ ëª©ë¡
const sosQuotes = [
    {
        text: "ì´ ìˆœê°„ì˜ ìœ í˜¹ì€ 5ë¶„ì´ë©´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. 5ë¶„ë§Œ ì°¸ìœ¼ì„¸ìš”. ë‹¹ì‹ ì€ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!",
        author: "ê¸ˆì—° ì „ë¬¸ê°€"
    },
    {
        text: "ë‹´ë°° í•œ ê°œë¹„ê°€ ë‹¹ì‹ ì˜ ëª¨ë“  ë…¸ë ¥ì„ ë¬´ë„ˆëœ¨ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì§€ê¸ˆê¹Œì§€ì˜ ë‹¹ì‹ ì„ ì§€ì¼œì£¼ì„¸ìš”.",
        author: "ê¸ˆì—° ë„ìš°ë¯¸"
    },
    {
        text: "ì´ ê³ í†µì€ ì¼ì‹œì ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ê¸ˆì—°ì˜ ì„±ê³µì€ í‰ìƒì…ë‹ˆë‹¤. ì§€ê¸ˆ ì´ ìˆœê°„ì„ ì´ê²¨ë‚´ì„¸ìš”!",
        author: "ë§ˆí¬ íŠ¸ì›¨ì¸"
    },
    {
        text: "ë‹´ë°°ë¥¼ í”¼ìš°ê³  ì‹¶ì€ ë§ˆìŒì€ íŒŒë„ì™€ ê°™ìŠµë‹ˆë‹¤. ë°€ë ¤ì™”ë‹¤ê°€ ë°˜ë“œì‹œ ë¹ ì ¸ë‚˜ê°‘ë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë¦¬ì„¸ìš”.",
        author: "ê¸ˆì—° ì‹¬ë¦¬í•™"
    },
    {
        text: "ë‹¹ì‹ ì€ ì´ë¯¸ [ì‹œê°„]ë™ì•ˆ ê¸ˆì—°í–ˆìŠµë‹ˆë‹¤. ì´ ê·€ì¤‘í•œ ì‹œê°„ì„ í¬ê¸°í•˜ì§€ ë§ˆì„¸ìš”!",
        author: "ë‹¹ì‹ ì˜ ì„±ê³¼"
    }
];

// SOS ëª¨ë‹¬ ì—´ê¸°
function showSOSModal() {
    // í˜„ì¬ ê¸ˆì—° ì‹œê°„ ê³„ì‚°
    if (userData.quitDateTime) {
        const now = new Date();
        const diff = now - userData.quitDateTime;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        const timeText = days > 0 ? `${days}ì¼ ${hours % 24}ì‹œê°„` : 
                        hours > 0 ? `${hours}ì‹œê°„ ${minutes % 60}ë¶„` : 
                        `${minutes}ë¶„`;
        
        document.getElementById('sosModalBody').innerHTML = `
    <div style="text-align: center;">
        <div style="font-size: clamp(16px, 4.5vw, 18px); font-weight: 700; color: var(--primary); margin-bottom: clamp(12px, 3vw, 16px);">
            ì ê¹! ìƒê°í•´ë³´ì„¸ìš”
        </div>
        <div style="font-size: clamp(14px, 3.5vw, 16px); line-height: 1.6; margin-bottom: clamp(12px, 3vw, 16px);">
            ë‹¹ì‹ ì€ ì´ë¯¸ <strong style="color: var(--primary);">${timeText}</strong> ë™ì•ˆ<br>
            ê¸ˆì—°ì— ì„±ê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤!
        </div>
        <div style="font-size: clamp(12px, 3vw, 14px); color: var(--text-secondary); line-height: 1.5;">
            ì´ ìˆœê°„ì˜ ìœ í˜¹ì€ ì•½ 5ë¶„ì´ë©´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.<br>
            ì•„ë˜ ë„êµ¬ë“¤ì´ ë‹¹ì‹ ì„ ë„ìš¸ ê²ƒì…ë‹ˆë‹¤.
        </div>
    </div>
`;
    } else {
        document.getElementById('sosModalBody').innerHTML = `
    <div style="text-align: center; font-size: clamp(14px, 3.5vw, 16px); line-height: 1.6;">
        ë‹¹ì‹ ì€ ê°•í•œ ì‚¬ëŒì…ë‹ˆë‹¤.<br>
        ì´ ìˆœê°„ì˜ ìœ í˜¹ì„ ì´ê²¨ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        ì•„ë˜ ë„êµ¬ë“¤ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.
    </div>
`;
    }
    
    document.getElementById('sosModal').classList.add('active');
    playNotificationSound();
}

// SOS ëª¨ë‹¬ ë‹«ê¸°
function closeSOSModal() {
    document.getElementById('sosModal').classList.remove('active');
    
    // ìœ„ê¸° ê·¹ë³µ ì¶•í•˜ ë©”ì‹œì§€
    showAchievementNotification({
        icon: 'ğŸ‰',
        title: 'ìœ„ê¸° ê·¹ë³µ!',
        desc: 'ìœ í˜¹ì„ ì´ê²¨ë‚¸ ë‹¹ì‹ ì€ ì •ë§ ê°•í•©ë‹ˆë‹¤!'
    }, 'sos');
}

// ì‹¬í˜¸í¡ ê°€ì´ë“œ í‘œì‹œ
function showBreathingGuide() {
    document.getElementById('sosModal').classList.remove('active');
    document.getElementById('breathingModal').classList.add('active');
    startBreathing();
}

// ì‹¬í˜¸í¡ ì‹œì‘
function startBreathing() {
    breathingCycle = 0;
    const circle = document.getElementById('breathingCircle');
    const text = document.getElementById('breathingText');
    const instruction = document.getElementById('breathingInstruction');
    
    function breatheCycle() {
        // ë“¤ì´ì‰¬ê¸° (4ì´ˆ)
        text.textContent = 'ë“¤ì´ì‰¬ê¸°';
        instruction.textContent = 'ì½”ë¡œ ì²œì²œíˆ ìˆ¨ì„ ë“¤ì´ë§ˆì‹œì„¸ìš” (4ì´ˆ)';
        circle.classList.remove('exhale');
        circle.classList.add('inhale');
        
        setTimeout(() => {
            // ì°¸ê¸° (4ì´ˆ)
            text.textContent = 'ì°¸ê¸°';
            instruction.textContent = 'ìˆ¨ì„ ì ì‹œ ë©ˆì¶”ì„¸ìš” (4ì´ˆ)';
            
            setTimeout(() => {
                // ë‚´ì‰¬ê¸° (4ì´ˆ)
                text.textContent = 'ë‚´ì‰¬ê¸°';
                instruction.textContent = 'ì…ìœ¼ë¡œ ì²œì²œíˆ ìˆ¨ì„ ë‚´ì‰¬ì„¸ìš” (4ì´ˆ)';
                circle.classList.remove('inhale');
                circle.classList.add('exhale');
                
                setTimeout(() => {
                    breathingCycle++;
                    if (breathingCycle < 5) {
                        breatheCycle();
                    } else {
                        text.textContent = 'ì™„ë£Œ!';
                        instruction.textContent = 'ì‹¬í˜¸í¡ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê¸°ë¶„ì´ ë‚˜ì•„ì¡Œë‚˜ìš”?';
                        circle.classList.remove('exhale');
                        setTimeout(() => {
                            stopBreathing();
                            showSOSModal();
                        }, 2000);
                    }
                }, 4000);
            }, 4000);
        }, 4000);
    }
    
    breatheCycle();
}

// ì‹¬í˜¸í¡ ì¤‘ì§€
function stopBreathing() {
    const circle = document.getElementById('breathingCircle');
    circle.classList.remove('inhale', 'exhale');
    document.getElementById('breathingModal').classList.remove('active');
}

// ê°•ë ¥í•œ ëª…ì–¸ í‘œì‹œ
function showMotivationalQuote() {
    let quote = sosQuotes[Math.floor(Math.random() * sosQuotes.length)];
    
    // í˜„ì¬ ê¸ˆì—° ì‹œê°„ì„ ëª…ì–¸ì— í¬í•¨
    if (quote.text.includes('[ì‹œê°„]') && userData.quitDateTime) {
        const now = new Date();
        const diff = now - userData.quitDateTime;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        const timeText = days > 0 ? `${days}ì¼ ${hours % 24}ì‹œê°„` : 
                        hours > 0 ? `${hours}ì‹œê°„ ${minutes % 60}ë¶„` : 
                        `${minutes}ë¶„`;
        
        quote.text = quote.text.replace('[ì‹œê°„]', timeText);
    }
    
    document.getElementById('sosModalBody').innerHTML = `
    <div style="text-align: center;">
        <div style="font-size: clamp(36px, 10vw, 48px); margin-bottom: clamp(12px, 3vw, 20px);">ğŸ’ª</div>
        <div style="font-size: clamp(15px, 4vw, 17px); font-weight: 600; line-height: 1.6; margin-bottom: clamp(12px, 3vw, 16px); color: var(--text);">
            "${quote.text}"
        </div>
        <div style="font-size: clamp(12px, 3vw, 14px); color: var(--text-secondary); font-style: italic;">
            - ${quote.author}
        </div>
    </div>
`;
}

// ê°œì¸ ë©”ì‹œì§€ í‘œì‹œ
function showPersonalMessage() {
    const savedMessage = localStorage.getItem('personalSOSMessage');
    
    if (savedMessage) {
        document.getElementById('sosModalBody').innerHTML = `
    <div style="text-align: center;">
        <div style="font-size: clamp(36px, 10vw, 48px); margin-bottom: clamp(12px, 3vw, 20px);">ğŸ’Œ</div>
        <div style="font-size: clamp(14px, 3.5vw, 16px); font-weight: 600; line-height: 1.6; color: var(--text); white-space: pre-wrap; max-height: 40vh; overflow-y: auto; padding: 0 10px;">
${savedMessage}
        </div>
    </div>
    <button class="modal-btn modal-btn-cancel" onclick="editPersonalMessage()" style="margin-top: clamp(12px, 3vw, 16px); width: 100%;">
        ë©”ì‹œì§€ ìˆ˜ì •í•˜ê¸°
    </button>
`;
    } else {
        document.getElementById('sosModal').classList.remove('active');
        document.getElementById('personalMessageModal').classList.add('active');
    }
}

// ê°œì¸ ë©”ì‹œì§€ ìˆ˜ì •
function editPersonalMessage() {
    const savedMessage = localStorage.getItem('personalSOSMessage');
    document.getElementById('personalMessageInput').value = savedMessage || '';
    document.getElementById('sosModal').classList.remove('active');
    document.getElementById('personalMessageModal').classList.add('active');
}

// ê°œì¸ ë©”ì‹œì§€ ì €ì¥
function savePersonalMessage() {
    const message = document.getElementById('personalMessageInput').value.trim();
    
    if (!message) {
        alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
    }
    
    localStorage.setItem('personalSOSMessage', message);
    closePersonalMessageModal();
    showSOSModal();
    
    // ì €ì¥ ì™„ë£Œ ë©”ì‹œì§€
    setTimeout(() => {
    document.getElementById('sosModalBody').innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: clamp(36px, 10vw, 48px); margin-bottom: clamp(12px, 3vw, 20px);">âœ…</div>
            <div style="font-size: clamp(14px, 3.5vw, 16px); font-weight: 600; color: var(--success); line-height: 1.6;">
                ë‚˜ì—ê²Œ ì“´ í¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!<br>
                ìœ„ê¸°ì˜ ìˆœê°„ì— ë‹¤ì‹œ ì½ì–´ë³´ì„¸ìš”.
            </div>
        </div>
    `;
}, 100);
}

// ê°œì¸ ë©”ì‹œì§€ ëª¨ë‹¬ ë‹«ê¸°
function closePersonalMessageModal() {
    document.getElementById('personalMessageModal').classList.remove('active');
}



function navigateToNextPage() {
    const nextIndex = (currentPageIndex + 1) % pageOrder.length;
    navigateTo(pageOrder[nextIndex]);
}

function navigateToPrevPage() {
    const prevIndex = (currentPageIndex - 1 + pageOrder.length) % pageOrder.length;
    navigateTo(pageOrder[prevIndex]);
}

function setDailyQuote() {
    const today = new Date().toDateString();
    const savedQuoteDate = localStorage.getItem('dailyQuoteDate');
    
    if (savedQuoteDate !== today) {
        const todayQuote = dailyQuotes[Math.floor(Math.random() * dailyQuotes.length)];
        localStorage.setItem('dailyQuote', JSON.stringify(todayQuote));
        localStorage.setItem('dailyQuoteDate', today);
    }
    
    const savedQuote = localStorage.getItem('dailyQuote');
    if (savedQuote) {
        const quote = JSON.parse(savedQuote);
        const quoteTextEl = document.getElementById('dailyQuoteText');
        const quoteAuthorEl = document.getElementById('dailyQuoteAuthor');
        if (quoteTextEl) quoteTextEl.textContent = `"${quote.text}"`;
        if (quoteAuthorEl) quoteAuthorEl.textContent = `- ${quote.author}`;
    }
}

function updateStats() {
    if (!userData.quitDateTime) return;
    const now = new Date();
    const diff = now - userData.quitDateTime;
    if (diff < 0) {
        document.getElementById('quitTime').textContent = 'ê³§ ì‹œì‘';
        return;
    }

    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    document.getElementById('quitTime').textContent = `${days}ì¼ ${hours % 24}ì‹œê°„ ${minutes % 60}ë¶„`;
    
    const daysElapsed = diff / 86400000;
    const savedMoney = Math.floor(daysElapsed * userData.packsPerDay * userData.pricePerPack);
    document.getElementById('savedMoney').textContent = `${savedMoney.toLocaleString()}ì›`;
    document.getElementById('totalSavings').textContent = `${savedMoney.toLocaleString()}ì›`;
    
    const cigarettesAvoided = Math.floor(daysElapsed * userData.packsPerDay * userData.cigarettesPerPack);
    document.getElementById('cigarettesAvoided').textContent = `${cigarettesAvoided.toLocaleString()}ê°œë¹„`;

    const lifeGained = cigarettesAvoided * 11;
    document.getElementById('lifeGained').textContent = lifeGained > 1440 
        ? `${(lifeGained/1440).toFixed(1)}ì¼`
        : lifeGained > 60 ? `${Math.floor(lifeGained/60)}ì‹œê°„` : `${lifeGained}ë¶„`;
    
    const maxMinutes = 5256000;
    const healthImprovement = Math.min(Math.floor((minutes / maxMinutes) * 100), 100);
    document.getElementById('healthImprovement').textContent = `${healthImprovement}%`;

    updateLevel(minutes);
    updateAchievements(minutes, savedMoney);
    updateSavings(savedMoney);
    updateSettings();
    updateProgressSummary(minutes, savedMoney, healthImprovement);
}

function updateProgressSummary(minutes, savedMoney, healthProgress) {
    let completedCount = milestones.filter(m => minutes >= m.minutes).length;
    let unlockedSavings = savingsGoals.filter(g => (savedMoney / g.price) * 100 >= 100).length;
    
    const completedCountEl = document.getElementById('completedCount');
    const unlockedSavingsEl = document.getElementById('unlockedSavings');
    const healthProgressEl = document.getElementById('healthProgress');
    
    if (completedCountEl) completedCountEl.textContent = `${completedCount}ê°œ`;
    if (unlockedSavingsEl) unlockedSavingsEl.textContent = `${unlockedSavings}ê°œ`;
    if (healthProgressEl) healthProgressEl.textContent = `${healthProgress}%`;
}

function updateLevel(minutes) {
    let currentLevel = 1, nextMilestone = null, prevMilestone = 0;
    for (let milestone of milestones) {
        if (minutes >= milestone.minutes) {
            currentLevel = milestone.level;
            prevMilestone = milestone.minutes;
        } else {
            nextMilestone = milestone;
            break;
        }
    }

    if (currentLevel > lastLevel && lastLevel > 0) {
        const currentMilestone = milestones.find(m => m.level === currentLevel);
        showAchievementNotification(currentMilestone, 'levelup');
        schedulePushNotification(
            `ğŸ‰ ë ˆë²¨ ${currentLevel} ë‹¬ì„±!`,
            `${currentMilestone.title} - ${currentMilestone.desc}`,
            0
        );
    }
    lastLevel = currentLevel;

    document.getElementById('levelNumber').textContent = currentLevel;
    document.getElementById('levelName').textContent = levelNames[currentLevel] || "ê¸ˆì—°ì™•";
    
    const currentLevelName = levelNames[currentLevel];
    const nextLevelName = levelNames[currentLevel + 1] || "ìµœê³  ë ˆë²¨";
    const currentLevelHomeEl = document.getElementById('currentLevelHome');
    if (currentLevelHomeEl) {
        currentLevelHomeEl.textContent = `${currentLevelName} Lv.${currentLevel}`;
    }
    
    if (nextMilestone) {
        const progress = Math.min(Math.floor(((minutes - prevMilestone) / (nextMilestone.minutes - prevMilestone)) * 100), 100);
        document.getElementById('levelProgressBar').style.width = progress + '%';
        document.getElementById('levelProgressText').textContent = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${progress}%`;
        
        const levelProgressMiniEl = document.getElementById('levelProgressMini');
        if (levelProgressMiniEl) levelProgressMiniEl.style.width = progress + '%';
        
        const nextLevelHomeEl = document.getElementById('nextLevelHome');
        if (nextLevelHomeEl) nextLevelHomeEl.textContent = `ë‹¤ìŒ: ${nextLevelName}`;
        
        const remainingMinutes = nextMilestone.minutes - minutes;
        const levelTimeRemainingEl = document.getElementById('levelTimeRemaining');
        if (levelTimeRemainingEl) {
            levelTimeRemainingEl.textContent = `ë‚¨ì€ ì‹œê°„: ${formatTime(remainingMinutes)}`;
        }
    } else {
        document.getElementById('levelProgressBar').style.width = '100%';
        document.getElementById('levelProgressText').textContent = 'ìµœê³  ë ˆë²¨ ë‹¬ì„±!';
        
        const levelProgressMiniEl = document.getElementById('levelProgressMini');
        if (levelProgressMiniEl) levelProgressMiniEl.style.width = '100%';
        
        const nextLevelHomeEl = document.getElementById('nextLevelHome');
        if (nextLevelHomeEl) nextLevelHomeEl.textContent = 'ìµœê³  ë ˆë²¨ ë‹¬ì„±!';
        
        const levelTimeRemainingEl = document.getElementById('levelTimeRemaining');
        if (levelTimeRemainingEl) levelTimeRemainingEl.textContent = 'ëª¨ë“  ë ˆë²¨ ì™„ë£Œ!';
    }
}

function formatTime(minutes) {
    if (minutes < 60) return `${minutes}ë¶„`;
    if (minutes < 1440) return `${Math.floor(minutes / 60)}ì‹œê°„`;
    if (minutes < 43200) return `${Math.floor(minutes / 1440)}ì¼`;
    if (minutes < 525600) return `${Math.floor(minutes / 43200)}ê°œì›”`;
    return `${Math.floor(minutes / 525600)}ë…„`;
}
function updateAchievements(minutes, savedMoney) {
    let completedHTML = '', nextHTML = '', allHTML = '';
    for (let milestone of milestones) {
        const isCompleted = minutes >= milestone.minutes;
        const timeText = formatTime(milestone.minutes);
        
        if (isCompleted && !achievedMilestones.has(milestone.level)) {
            achievedMilestones.add(milestone.level);
            showAchievementNotification(milestone, 'achievement');
            schedulePushNotification(
                `ğŸ† ${milestone.title} ë‹¬ì„±!`,
                milestone.desc,
                0
            );
            saveDataSecure();
        }
        
        if (isCompleted) {
            completedHTML += createAchievementHTML(milestone, true, 100, timeText);
            allHTML += createProgressAchievementHTML(milestone, true, 100);
        } else {
            if (!nextHTML) {
                const remaining = milestone.minutes - minutes;
                nextHTML = createAchievementHTML(milestone, false, 0, `${formatTime(remaining)} ë‚¨ìŒ`);
            }
            const progress = Math.min((minutes / milestone.minutes) * 100, 99);
            allHTML += createProgressAchievementHTML(milestone, false, progress);
        }
    }

    document.getElementById('completedAchievements').innerHTML = completedHTML ||
    '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ì•„ì§ ë‹¬ì„±í•œ ì—…ì ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    
    document.getElementById('nextAchievement').innerHTML = nextHTML ||
    '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ëª¨ë“  ì—…ì ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! ğŸ‰</div>';
    
    document.getElementById('allAchievements').innerHTML = allHTML;
}

function createAchievementHTML(milestone, isCompleted, progress, timeText) {
    const className = isCompleted ? 'completed' : '';
    return `
        <div class="achievement-item ${className}">
            <div class="achievement-icon">${milestone.icon}</div>
            <div class="achievement-content">
                <div class="achievement-title">${milestone.title}</div>
                <div class="achievement-desc">${milestone.desc}</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                    ${isCompleted ? 'âœ… ' + timeText : 'â³ ' + timeText}
                </div>
            </div>
        </div>
    `;
}

function createProgressAchievementHTML(milestone, isCompleted, progress) {
    const className = isCompleted ? 'completed' : (progress > 0 ? '' : 'locked');
    return `
        <div class="achievement-item ${className}">
            <div class="achievement-icon">${milestone.icon}</div>
            <div class="achievement-content">
                <div class="achievement-title">${milestone.title}</div>
                <div class="achievement-desc">${milestone.desc}</div>
                <div class="achievement-progress">
                    <div class="achievement-progress-fill" style="width: ${progress}%"></div>
                </div>
                <div style="text-align: right; font-size: 12px; font-weight: 700; color: var(--primary); margin-top: 4px;">
                    ${Math.floor(progress)}%
                </div>
            </div>
        </div>
    `;
}

function updateSavings(savedMoney) {
    let html = '';
    for (let goal of savingsGoals) {
        const progress = Math.min((savedMoney / goal.price) * 100, 100);
        const isUnlocked = progress >= 100;
        const className = isUnlocked ? 'unlocked' : '';
        
        if (isUnlocked && !unlockedSavingsGoals.has(goal.name)) {
            unlockedSavingsGoals.add(goal.name);
            showAchievementNotification(goal, 'savings');
            schedulePushNotification(
                `ğŸ’° ${goal.name} ë‹¬ì„±!`,
                `${goal.price.toLocaleString()}ì›ì„ ì ˆì•½í–ˆìŠµë‹ˆë‹¤!`,
                0
            );
            saveDataSecure();
        }
        
        html += `
            <div class="savings-item ${className}">
                <div class="savings-header">
                    <div class="savings-emoji">${goal.emoji}</div>
                    <div class="savings-info">
                        <div class="savings-name">${goal.name}</div>
                        <div class="savings-price">${goal.price.toLocaleString()}ì›</div>
                    </div>
                    ${isUnlocked ? '<div style="font-size: 24px;">âœ…</div>' : ''}
                </div>
                <div class="savings-progress-bar">
                    <div class="savings-progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="savings-percent">${Math.floor(progress)}%</div>
            </div>
        `;
    }
    
    document.getElementById('savingsItems').innerHTML = html;
}

function updateSettings() {
    if (userData.userName) {
        document.getElementById('profileName').textContent = userData.userName;
    }
    
    if (userData.quitDateTime) {
        const quitDate = new Date(userData.quitDateTime);
        document.getElementById('quitStartDate').textContent = 
            `${quitDate.getFullYear()}ë…„ ${quitDate.getMonth() + 1}ì›” ${quitDate.getDate()}ì¼ ì‹œì‘`;
    }

    if (userData.smokingYears && userData.packsPerDay) {
        const riskLevel = userData.riskScore < 50 ? 'ë‚®ìŒ' : userData.riskScore < 150 ? 'ì¤‘ê°„' : 'ë†’ìŒ';
        const pastSmokingInfoHomeEl = document.getElementById('pastSmokingInfoHome');
        if (pastSmokingInfoHomeEl) {
            pastSmokingInfoHomeEl.textContent = 
                `${userData.smokingYears}ë…„ê°„ í•˜ë£¨ ${userData.packsPerDay}ê°‘ (ìœ„í—˜ë„: ${riskLevel})`;
        }
    }
}

function showPastSmokingInfo() {
    if (!userData.smokingYears) return;
    const riskLevel = userData.riskScore < 50 ? 'ë‚®ì€ ìœ„í—˜ë„' : userData.riskScore < 150 ? 'ì¤‘ê°„ ìœ„í—˜ë„' : 'ë†’ì€ ìœ„í—˜ë„';
    const totalCigarettes = Math.floor(userData.smokingYears * 365 * userData.packsPerDay * userData.cigarettesPerPack);
    const totalSpent = Math.floor(userData.smokingYears * 365 * userData.packsPerDay * userData.pricePerPack);
    const details = `
        <div style="text-align: left; line-height: 1.8;">
            <strong>ğŸ“Š í¡ì—° í†µê³„</strong><br>
            â€¢ í¡ì—° ê¸°ê°„: ${userData.smokingYears}ë…„<br>
            â€¢ í•˜ë£¨ í¡ì—°ëŸ‰: ${userData.packsPerDay}ê°‘<br>
            â€¢ ì›” í‰ê·  ë‹´ë°°ë¹„: ${userData.monthlySpending?.toLocaleString() || 0}ì›<br><br>
            
            <strong>âš ï¸ ìœ„í—˜ë„ í‰ê°€</strong><br>
            â€¢ ìœ„í—˜ ìˆ˜ì¤€: <span style="color: ${userData.riskScore < 50 ? 'var(--success)' : userData.riskScore < 150 ? 'var(--warning)' : 'var(--danger)'}; font-weight: bold;">${riskLevel}</span><br><br>
            
            <strong>ğŸ’° ê³¼ê±° ì´ ì†Œë¹„</strong><br>
            â€¢ ì´ í¡ì—° ê°œë¹„: ${totalCigarettes.toLocaleString()}ê°œë¹„<br>
            â€¢ ì´ ì†Œë¹„ ê¸ˆì•¡: ${totalSpent.toLocaleString()}ì›<br><br>
            
            <strong>ğŸ‰ ê¸ˆì—° ì„±ê³¼</strong><br>
            ì´ì œ ì´ ëª¨ë“  ê²ƒì„ ê·¹ë³µí•˜ê³  ê³„ì‹­ë‹ˆë‹¤!
        </div>
    `;
    
    document.getElementById('pastSmokingDetails').innerHTML = details;
    document.getElementById('pastSmokingModal').classList.add('active');
}

function closePastSmokingModal() {
    document.getElementById('pastSmokingModal').classList.remove('active');
}

function resetQuit() {
    if (!userData.quitDateTime) {
        document.getElementById('resetModal').classList.add('active');
        return;
    }

    // í˜„ì¬ê¹Œì§€ì˜ ì„±ê³¼ ê³„ì‚°
    const now = new Date();
    const diff = now - userData.quitDateTime;
    const minutes = Math.floor(diff / 60000);
    const daysElapsed = diff / 86400000;
    
    const savedMoney = Math.floor(daysElapsed * userData.packsPerDay * userData.pricePerPack);
    const cigarettesAvoided = Math.floor(daysElapsed * userData.packsPerDay * userData.cigarettesPerPack);
    const lifeGained = cigarettesAvoided * 11;
    
    let lifeGainedText = '';
    if (lifeGained > 1440) {
        lifeGainedText = `${(lifeGained/1440).toFixed(1)}ì¼`;
    } else if (lifeGained > 60) {
        lifeGainedText = `${Math.floor(lifeGained/60)}ì‹œê°„`;
    } else {
        lifeGainedText = `${lifeGained}ë¶„`;
    }
    
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    // ê¸ì •ì ì¸ ë©”ì‹œì§€ ìƒì„±
    const motivationalMessage = `
    <div style="text-align: center; line-height: 1.6;">
        <div style="font-size: clamp(32px, 10vw, 48px); margin-bottom: clamp(8px, 2vw, 16px);">ğŸ’ª</div>
        <div style="font-size: clamp(15px, 4vw, 18px); font-weight: 700; color: var(--primary); margin-bottom: clamp(10px, 2.5vw, 16px);">
            ì‹¤íŒ¨ê°€ ì•„ë‹Œ<br>ë‹¤ìŒ ë‹¨ê³„ë¡œ ê°€ëŠ” ì ì‹œ ë©ˆì¶¤ì…ë‹ˆë‹¤
        </div>
        <div style="background: var(--gradient-glow); padding: clamp(12px, 3vw, 20px); border-radius: 12px; margin-bottom: clamp(10px, 2.5vw, 16px);">
            <div style="font-size: clamp(11px, 2.8vw, 14px); color: var(--text-secondary); margin-bottom: clamp(6px, 1.5vw, 12px);">
                ë‹¹ì‹ ì€ ì´ ê¸°ê°„ ë™ì•ˆ
            </div>
            <div style="font-size: clamp(13px, 3.5vw, 16px); font-weight: 700; color: var(--primary);">
                ğŸ’° ${savedMoney.toLocaleString()}ì›ì„ ì•„ê¼ˆê³ <br>
                â¤ï¸ ${lifeGainedText}ì˜ ìˆ˜ëª…ì„ ëŠ˜ë ¸ìœ¼ë©°<br>
                ğŸš­ ${cigarettesAvoided.toLocaleString()}ê°œë¹„ë¥¼ í”¼ìš°ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
            </div>
        </div>
        <div style="font-size: clamp(11px, 2.8vw, 14px); color: var(--text-secondary); line-height: 1.5;">
            ${days}ì¼ê°„ì˜ ë…¸ë ¥ì€ ê²°ì½” ì‚¬ë¼ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
            ë‹¤ì‹œ ì‹œì‘í•˜ëŠ” ê²ƒì€ ìš©ê¸°ì…ë‹ˆë‹¤.<br>
            ì–¸ì œë“ ì§€ ë‹¤ì‹œ ë„ì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
        </div>
    </div>
`;
    
    document.getElementById('resetModalText').innerHTML = motivationalMessage;
    document.getElementById('resetModal').classList.add('active');
}

function closeResetModal() {
    document.getElementById('resetModal').classList.remove('active');
}

function confirmReset() {
    ['quitSmokingData', 'quitSmokingData_backup', 'quitSmokingData_timestamp', 'dailyQuote', 'dailyQuoteDate', 'theme'].forEach(key => {
        localStorage.removeItem(key);
        sessionStorage.removeItem(key);
    });
    sessionStorage.removeItem('quitSmokingData_emergency');
    
    if (db) {
        db.executeSql('DELETE FROM userData WHERE id = 1', [], 
            () => console.log('SQLite data cleared'),
            (error) => console.error('SQLite delete error:', error)
        );
    }
    
    if (updateInterval) clearInterval(updateInterval);
    if (motivationInterval) clearInterval(motivationInterval);
    
    achievedMilestones.clear();
    unlockedSavingsGoals.clear();
    lastLevel = 0;
    
    userData = {};
    location.reload();
}

function toggleDailyReminders() {
    const isEnabled = localStorage.getItem('dailyRemindersEnabled') !== 'false';
    const newState = !isEnabled;
    
    localStorage.setItem('dailyRemindersEnabled', newState.toString());
    
    const toggle = document.getElementById('reminderToggle');
    if (newState) {
        toggle.classList.add('active');
        scheduleDailyReminders();
    } else {
        toggle.classList.remove('active');
        // ì¼ì¼ ì•Œë¦¼ë§Œ ì·¨ì†Œ (ID 1000ë²ˆëŒ€)
        if (window.cordova && window.cordova.plugins && window.cordova.plugins.notification) {
            [1000, 1001, 1002].forEach(id => {
                window.cordova.plugins.notification.local.cancel(id);
            });
        }
    }
}

function testNotification() {
    if (!window.cordova || !window.cordova.plugins || !window.cordova.plugins.notification) {
        alert('ì•Œë¦¼ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    window.cordova.plugins.notification.local.schedule({
        id: 9999,
        title: 'ğŸ‰ ì•Œë¦¼ í…ŒìŠ¤íŠ¸',
        text: 'ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!',
        trigger: { in: 3, unit: 'second' },
        foreground: true,
        priority: 2,
        vibrate: true,
        sound: 'res://platform_default',
        badge: 1
    });
    
    alert('3ì´ˆ í›„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì´ í‘œì‹œë©ë‹ˆë‹¤.');
}

// í˜ì´ì§€ ë¡œë“œì‹œ ì•Œë¦¼ í† ê¸€ ìƒíƒœ ë³µì›
function loadNotificationSettings() {
    const isEnabled = localStorage.getItem('dailyRemindersEnabled') !== 'false';
    const toggle = document.getElementById('reminderToggle');
    if (toggle) {
        if (isEnabled) {
            toggle.classList.add('active');
        } else {
            toggle.classList.remove('active');
        }
    }
}

function showAchievementNotification(item, type) {
    const overlay = document.getElementById('achievementOverlay');
    const notification = document.getElementById('achievementNotification');
    const icon = document.getElementById('achievementIcon');
    const title = document.getElementById('achievementTitle');
    const desc = document.getElementById('achievementDesc');
    
    if (type === 'levelup' || type === 'achievement') {
        icon.textContent = item.icon;
        title.textContent = type === 'levelup' ? `ğŸ‰ ë ˆë²¨ ${item.level} ë‹¬ì„±!` : `ğŸ† ${item.title}`;
        desc.textContent = item.desc;
    } else if (type === 'savings') {
        icon.textContent = item.emoji;
        title.textContent = `ğŸ’° ${item.name} ë‹¬ì„±!`;
        desc.textContent = `${item.price.toLocaleString()}ì›ì„ ì ˆì•½í–ˆìŠµë‹ˆë‹¤!`;
    }
    
    playNotificationSound();
    
    overlay.classList.add('show');
    notification.classList.add('show');
}

function closeAchievementNotification() {
    const overlay = document.getElementById('achievementOverlay');
    const notification = document.getElementById('achievementNotification');
    
    overlay.classList.remove('show');
    notification.classList.remove('show');
}

function playNotificationSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        console.log('Audio not supported');
    }
}

function initPushNotifications() {
    if (!window.cordova || !window.cordova.plugins || !window.cordova.plugins.notification) {
        console.log('Push notifications not available');
        return;
    }
    
    // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
    window.cordova.plugins.notification.local.hasPermission(function(granted) {
        if (!granted) {
            // ê¶Œí•œì´ ì—†ìœ¼ë©´ ìš”ì²­
            window.cordova.plugins.notification.local.requestPermission(function(granted) {
                if (granted) {
                    console.log('ì•Œë¦¼ ê¶Œí•œì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤');
                    setupNotifications();
                } else {
                    console.log('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
                    alert('ì•Œë¦¼ì„ ë°›ìœ¼ë ¤ë©´ ì„¤ì •ì—ì„œ ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                }
            });
        } else {
            console.log('ì•Œë¦¼ ê¶Œí•œì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤');
            setupNotifications();
        }
    });
    
    // ì•Œë¦¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    window.cordova.plugins.notification.local.on('click', function(notification) {
        console.log('Notification clicked:', notification);
        // ì•±ì´ ë°±ê·¸ë¼ìš´ë“œì— ìˆìœ¼ë©´ í¬ê·¸ë¼ìš´ë“œë¡œ ê°€ì ¸ì˜¤ê¸°
        if (userData.quitDateTime) {
            updateStats();
        }
    });
    
    // ì•Œë¦¼ íŠ¸ë¦¬ê±° ì´ë²¤íŠ¸ ì²˜ë¦¬
    window.cordova.plugins.notification.local.on('trigger', function(notification) {
        console.log('Notification triggered:', notification);
    });
}

function setupNotifications() {
    // ê¸°ì¡´ ì•Œë¦¼ ëª¨ë‘ ì·¨ì†Œ
    window.cordova.plugins.notification.local.cancelAll(function() {
        console.log('ê¸°ì¡´ ì•Œë¦¼ ì·¨ì†Œë¨');
        
        // ìƒˆë¡œìš´ ì•Œë¦¼ ìŠ¤ì¼€ì¤„ë§
        if (userData.quitDateTime) {
            scheduleUpcomingMilestones();
            scheduleDailyReminders();
        }
    });
}

function scheduleUpcomingMilestones() {
    if (!window.cordova || !window.cordova.plugins || !window.cordova.plugins.notification) return;
    if (!userData.quitDateTime) return;
    
    const now = new Date();
    const diff = now - userData.quitDateTime;
    const currentMinutes = Math.floor(diff / 60000);
    
    let notificationId = 1;
    
    // ë‹¤ê°€ì˜¤ëŠ” ë§ˆì¼ìŠ¤í†¤ ì•Œë¦¼ ì˜ˆì•½
    for (let milestone of milestones) {
        if (milestone.minutes > currentMinutes) {
            const triggerTime = new Date(userData.quitDateTime.getTime() + milestone.minutes * 60000);
            
            // ë¯¸ë˜ ì‹œê°„ì¸ì§€ í™•ì¸
            if (triggerTime > now) {
                window.cordova.plugins.notification.local.schedule({
                    id: notificationId++,
                    title: `ğŸ‰ ${milestone.title} ë‹¬ì„±!`,
                    text: milestone.desc,
                    trigger: { at: triggerTime },
                    foreground: true,
                    priority: 2,
                    vibrate: true,
                    led: { color: '#6366f1', on: 500, off: 500 },
                    icon: 'res://icon',
                    smallIcon: 'res://ic_stat_notify',
                    sound: 'res://platform_default',
                    badge: 1,
                    wakeup: true,
                    launch: true
                });
                
                console.log(`ë§ˆì¼ìŠ¤í†¤ ì•Œë¦¼ ì˜ˆì•½: ${milestone.title} at ${triggerTime}`);
            }
        }
    }
}

function scheduleDailyReminders() {
    if (!window.cordova || !window.cordova.plugins || !window.cordova.plugins.notification) return;
    
    // ë§¤ì¼ ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 3ì‹œ, ì €ë… 9ì‹œì— ê²©ë ¤ ì•Œë¦¼
    const reminderTimes = [
        { hour: 9, minute: 0, message: 'ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤! ì˜¤ëŠ˜ë„ ê¸ˆì—° í™”ì´íŒ…! ğŸ’ª' },
        { hour: 15, minute: 0, message: 'ì˜í•˜ê³  ê³„ì‹­ë‹ˆë‹¤! ì˜¤í›„ë„ í˜ë‚´ì„¸ìš”! ğŸŒŸ' },
        { hour: 21, minute: 0, message: 'ì˜¤ëŠ˜ í•˜ë£¨ë„ ê¸ˆì—° ì„±ê³µ! ìë‘ìŠ¤ëŸ½ìŠµë‹ˆë‹¤! ğŸ‰' }
    ];
    
    let notificationId = 1000; // ë§ˆì¼ìŠ¤í†¤ê³¼ êµ¬ë¶„í•˜ê¸° ìœ„í•´ í° ìˆ«ì ì‚¬ìš©
    
    reminderTimes.forEach(time => {
        const now = new Date();
        const triggerTime = new Date();
        triggerTime.setHours(time.hour, time.minute, 0, 0);
        
        // ì˜¤ëŠ˜ ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ë‚´ì¼ë¡œ
        if (triggerTime <= now) {
            triggerTime.setDate(triggerTime.getDate() + 1);
        }
        
        window.cordova.plugins.notification.local.schedule({
            id: notificationId++,
            title: 'ê¸ˆì—° ë„ìš°ë¯¸',
            text: time.message,
            trigger: { 
                at: triggerTime,
                every: 'day' // ë§¤ì¼ ë°˜ë³µ
            },
            foreground: true,
            priority: 1,
            vibrate: true,
            icon: 'res://icon',
            smallIcon: 'res://ic_stat_notify',
            sound: 'res://platform_default',
            wakeup: true,
            launch: false // í´ë¦­í•˜ì§€ ì•Šìœ¼ë©´ ì•± ì‹¤í–‰ ì•ˆí•¨
        });
    });
    
    console.log('ì¼ì¼ ë¦¬ë§ˆì¸ë” ì˜ˆì•½ ì™„ë£Œ');
}

function schedulePushNotification(title, message, triggerTime) {
    if (!window.cordova || !window.cordova.plugins || !window.cordova.plugins.notification) return;
    
    window.cordova.plugins.notification.local.schedule({
        title: title,
        text: message,
        trigger: triggerTime instanceof Date ? { at: triggerTime } : { in: triggerTime, unit: 'second' },
        foreground: true,
        vibrate: true,
        led: { color: '#6366f1', on: 500, off: 500 },
        icon: 'res://icon',
        smallIcon: 'res://ic_notification',
        sound: 'file://sound.mp3'
    });
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    const toggle = document.getElementById('themeToggle');
    if (newTheme === 'dark') {
        toggle.classList.add('active');
    } else {
        toggle.classList.remove('active');
    }
}

function loadTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
        const toggle = document.getElementById('themeToggle');
        if (savedTheme === 'dark') {
            toggle.classList.add('active');
        }
    }
}

function shareApp() {
    if (navigator.share) {
        navigator.share({
            title: 'ê¸ˆì—° ë„ìš°ë¯¸',
            text: 'ê±´ê°•í•œ ê¸ˆì—°ì„ ë„ì™€ì£¼ëŠ” ì•±ì…ë‹ˆë‹¤!',
            url: window.location.href
        }).catch(() => {});
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }).catch(() => {});
    }
}

function sendEmail() {
    const subject = encodeURIComponent('ê¸ˆì—° ë„ìš°ë¯¸ ì•± í”¼ë“œë°±');
    const body = encodeURIComponent('ì•ˆë…•í•˜ì„¸ìš”! ê¸ˆì—° ë„ìš°ë¯¸ ì•±ì— ëŒ€í•œ í”¼ë“œë°±ì„ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.\n\n');
    window.open(`mailto:developer@example.com?subject=${subject}&body=${body}`);
}

// js/index.js íŒŒì¼ ë‚´ë¶€ì— ì¶”ê°€ (ë˜ëŠ” ì‚¬ìš©ìê°€ ì •ì˜í•œ ë©”ì¸ JS íŒŒì¼ì— ì¶”ê°€)

document.addEventListener('deviceready', function () {
    console.log("Cordova Device Ready");

    // ==========================================================
    // ğŸ”” [í•µì‹¬] ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì½”ë“œ (Android 13+ ëŒ€ì‘)
    // ==========================================================
    if (cordova.plugins.notification.local) {
        // 1. ê¶Œí•œ ìƒíƒœ í™•ì¸
        cordova.plugins.notification.local.hasPermission(function (granted) {
            if (!granted) {
                // 2. ê¶Œí•œì´ ì—†ìœ¼ë©´ ìš”ì²­ (ì´ë•Œ OS íŒì—…ì´ ëœ¹ë‹ˆë‹¤)
                cordova.plugins.notification.local.requestPermission(function (isGranted) {
                    if (isGranted) {
                        console.log("ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨.");
                    } else {
                        console.warn("ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨.");
                        // "Alert ì•Œë¦¼ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ë¥¼ ì´ ê²½ìš°ì— ë„ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        alert("ì•±ì˜ ì•Œë¦¼ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤."); 
                    }
                });
            } else {
                console.log("ì•Œë¦¼ ê¶Œí•œì´ ì´ë¯¸ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        });
    } else {
        // í”ŒëŸ¬ê·¸ì¸ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë””ë²„ê·¸ ë©”ì‹œì§€
        console.error("Local Notification Plugin is not available.");
    }
    // ==========================================================

    // ì´ ì™¸ì— Device, SQLite ë“± ë‹¤ë¥¸ í”ŒëŸ¬ê·¸ì¸ì„ ì´ˆê¸°í™”í•˜ëŠ” ì½”ë“œë¥¼ ì—¬ê¸°ì— ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.

}, false);
</script>
</body>
</html>